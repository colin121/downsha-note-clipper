var Downsha=Downsha||{};Downsha.inherit=function(a,b,c){"function"==typeof b.constructor?(a.prototype=new b,a.prototype.constructor=a,a.parent=b.prototype):(a.prototype=b,a.prototype.constructor=a,a.parent=b);if(c)for(var d in b.prototype.constructor)"parent"!=d&&"prototype"!=d&&"javaClass"!=d&&b.constructor[d]!=b.prototype.constructor[d]&&(a.prototype.constructor[d]=b.prototype.constructor[d]);"function"==typeof a.prototype.handleInheritance&&a.prototype.handleInheritance.apply(a,[a,b,c])};
Downsha.inherits=function(a,b){for(var c=a;c&&"undefined"!=typeof c.parent;){if(c.parent.constructor==b)return!0;c=c.parent.constructor}return!1};Downsha.mixin=function(a,b,c){var a="function"==typeof a?a.prototype:a,d;for(d in b.prototype){var e=to=d;"object"==typeof c&&c&&"undefined"!=typeof c[d]&&(to=c[d]);a[to]=b.prototype[e]}};
Downsha.extendObject=function(a,b,c){if("object"==typeof b&&null!=b)for(var d in b)if(c&&"object"==typeof b[d]&&null!=b[d]&&"object"==typeof a[d]&&null!=a[d])Downsha.extendObject(a[d],b[d],c);else try{a[d]=b[d]}catch(e){}};Downsha.hasOwnProperty=function(a,b){if("object"==typeof a){if(a.hasOwnProperty(b))return!0;for(var c=null,c=a;c=c.__proto__;)if(c.hasOwnProperty(b))return!0}return!1};Downsha.DefiningMixin=function(){};
Downsha.DefiningMixin._getTargetFor=function(a){return"function"==typeof a&&a==a.prototype.constructor?a.prototype:a};Downsha.DefiningMixin.prototype.__defineBoolean__=function(a,b,c,d){var e="_"+a,f=a.substring(0,1).toUpperCase()+a.substring(1),g=Downsha.DefiningMixin._getTargetFor(arguments.callee.caller);g[e]=b?!0:!1;if(!c){var h="is"+f;g[h]=function(){return this[e]};this.__defineGetter__(a,g[h])}d||(f="set"+f,g[f]=function(a){this[e]=a?!0:!1},this.__defineSetter__(a,g[f]))};
Downsha.DefiningMixin.prototype.__defineFloat__=function(a,b,c,d){this._createNumericDefinition_(Downsha.DefiningMixin._getTargetFor(arguments.callee.caller),a,b,!1,parseFloat,c,d)};Downsha.DefiningMixin.prototype.__definePositiveFloat__=function(a,b,c,d){this._createNumericDefinition_(Downsha.DefiningMixin._getTargetFor(arguments.callee.caller),a,b,!0,parseFloat,c,d)};
Downsha.DefiningMixin.prototype.__defineInteger__=function(a,b,c,d){this._createNumericDefinition_(Downsha.DefiningMixin._getTargetFor(arguments.callee.caller),a,b,!1,parseInt,c,d)};Downsha.DefiningMixin.prototype.__definePositiveInteger__=function(a,b,c,d){this._createNumericDefinition_(Downsha.DefiningMixin._getTargetFor(arguments.callee.caller),a,b,!0,parseInt,c,d)};
Downsha.DefiningMixin.prototype._createNumericDefinition_=function(a,b,c,d,e,f,g){var h=b.substring(0,1).toUpperCase()+b.substring(1),i="_"+b,c="number"==typeof c?c:null;a||(a=this);a[i]=c;f||(f="get"+h,a[f]=function(){return this[i]},this.__defineGetter__(b,a[f]));g||(g="set"+h,a[g]=d?function(a){this[i]=e(a);if(isNaN(this[i])||this[i]<0)this[i]=c}:function(a){this[i]=e(a);isNaN(this[i])&&(this[i]=c)},this.__defineSetter__(b,a[g]))};
Downsha.DefiningMixin.prototype.__defineString__=function(a,b,c,d){var b=b?b:null,e=a.substring(0,1).toUpperCase()+a.substring(1),f="_"+a,g=Downsha.DefiningMixin._getTargetFor(arguments.callee.caller);g[f]=b;if(!c){var h="get"+e;g[h]=function(){return this[f]};this.__defineGetter__(a,g[h])}d||(e="set"+e,g[e]=function(a){this[f]="string"==typeof a?a:a?""+a:b},this.__defineSetter__(a,g[e]))};
Downsha.DefiningMixin.prototype.__defineType__=function(a,b,c,d,e){var c=c?c:null,f="_"+a,g=a.substring(0,1).toUpperCase()+a.substring(1),h=Downsha.DefiningMixin._getTargetFor(arguments.callee.caller);h[f]=c;if(!d){var i="get"+g;h[i]=function(){return this[f]};this.__defineGetter__(a,h[i])}e||(g="set"+g,h[g]=function(a){if("string"==typeof b&&a&&a.constructor.name==b)this[f]=a;else if("function"==typeof b&&a instanceof b)this[f]=a;else{if(a)throw Error("Expected "+("string"==typeof b?b:b.name)+" but got "+
typeof a);this[f]=c}},this.__defineSetter__(a,h[g]))};
Downsha.Logger=function(a,b,c){this.__defineGetter__("level",this.getLevel);this.__defineSetter__("level",this.setLevel);this.__defineGetter__("scope",this.getScope);this.__defineSetter__("scope",this.setScope);this.__defineGetter__("scopeName",this.getScopeName);this.__defineGetter__("scopeNameAsPrefix",this.getScopeNameAsPrefix);this.__defineGetter__("useTimestamp",this.isUseTimestamp);this.__defineSetter__("useTimestamp",this.setUseTimestamp);this.__defineGetter__("usePrefix",this.isUsePrefix);
this.__defineSetter__("usePrefix",this.setUsePrefix);this.__defineGetter__("enabled",this.isEnabled);this.__defineSetter__("enabled",this.setEnabled);this.scope=a||arguments.callee.caller;this.level=b;if("undefined"!=typeof c&&c instanceof Downsha.LoggerImpl)this.impl=c;else{var d=Downsha.LoggerImplFactory.getImplementationFor(navigator);this.impl=d instanceof Array?new Downsha.LoggerChainImpl(this,d):new d(this)}};Downsha.Logger.LOG_LEVEL_DEBUG=0;Downsha.Logger.LOG_LEVEL_INFO=1;
Downsha.Logger.LOG_LEVEL_WARN=2;Downsha.Logger.LOG_LEVEL_ERROR=3;Downsha.Logger.LOG_LEVEL_EXCEPTION=4;Downsha.Logger.LOG_LEVEL_OFF=5;Downsha.Logger.GLOBAL_LEVEL=Downsha.Logger.LOG_LEVEL_ERROR;Downsha.Logger.DEBUG_PREFIX="[DEBUG] ";Downsha.Logger.INFO_PREFIX="[INFO] ";Downsha.Logger.WARN_PREFIX="[WARN] ";Downsha.Logger.ERROR_PREFIX="[ERROR] ";Downsha.Logger.EXCEPTION_PREFIX="[EXCEPTION] ";Downsha.Logger._instances={};
Downsha.Logger.getInstance=function(a){var a=a||arguments.callee.caller,b="function"==typeof a?a.name:a.constructor.name;"undefined"==typeof this._instances[b]&&(this._instances[b]=new Downsha.Logger(a));return this._instances[b]};Downsha.Logger.setInstance=function(a){this._instance=a};Downsha.Logger.destroyInstance=function(a){a=a||arguments.callee.caller;delete this._instances["function"==typeof a?a.name:a.constructor.name]};
Downsha.Logger.setGlobalLevel=function(a){a=parseInt(a);if(!isNaN(a)&&(Downsha.Logger.GLOBAL_LEVEL=a,this._instances))for(var b in this._instances)this._instances[b].setLevel(a)};Downsha.Logger.setLevel=function(a){if(this._instances)for(var b in this._instances)this._instances[b].setLevel(a)};Downsha.Logger.enableImplementor=function(a){if(this._instances)for(var b in this._instances)this._instances[b].enableImplementor(a);a&&(a.protoEnabled=!0)};
Downsha.Logger.disableImplementor=function(a){if(this._instances)for(var b in this._instances)this._instances[b].disableImplementor(a);a&&(a.protoEnabled=!1)};Downsha.Logger.prototype._level=0;Downsha.Logger.prototype._scope=null;Downsha.Logger.prototype._usePrefix=!0;Downsha.Logger.prototype._useTimestamp=!0;Downsha.Logger.prototype._enabled=!0;Downsha.Logger.prototype.getImplementor=function(a){return a?this.impl.answerImplementorInstance(a):this.impl};
Downsha.Logger.prototype.enableImplementor=function(a){if(a){if(a=this.getImplementor(a))a.enabled=!0}else this.impl.enabled=!0};Downsha.Logger.prototype.disableImplementor=function(a){if(a){if(a=this.getImplementor(a))a.enabled=!1}else this.impl.enabled=!1};Downsha.Logger.prototype.setLevel=function(a){this._level=parseInt(a);isNaN(this._level)&&(this._level=Downsha.Logger.GLOBAL_LEVEL)};Downsha.Logger.prototype.getLevel=function(){return this._level};
Downsha.Logger.prototype.setScope=function(a){"function"==typeof a?this._scope=a:"object"==typeof a&&null!=a&&(this._scope=a.constructor)};Downsha.Logger.prototype.getScope=function(){return this._scope};Downsha.Logger.prototype.getScopeName=function(){return this.scope?this.scope.name:""};Downsha.Logger.prototype.getScopeNameAsPrefix=function(){var a=this.scopeName;return a?"["+a+"] ":""};
Downsha.Logger.prototype._padNumber=function(a,b){a=parseInt(a);isNaN(a)&&(a=0);for(var c=0<=a?!0:!1,d=""+Math.abs(a);d.length<b;)d="0"+d;c||(d="-"+d);return d};
Downsha.Logger.prototype.getPrefix=function(a){var b="";if(this.useTimestamp)var c=new Date,d=c.getFullYear(),e=this._padNumber(c.getMonth()+1,2),f=this._padNumber(c.getDate(),2),g=this._padNumber(c.getHours(),2),h=this._padNumber(c.getMinutes(),2),i=this._padNumber(c.getSeconds(),2),c=this._padNumber(c.getMilliseconds(),3),b=b+(d+"/"+e+"/"+f+" "+g+":"+h+":"+i+"."+c+" ");this.usePrefix&&(b+=a);return b+=this.scopeNameAsPrefix};Downsha.Logger.prototype.isUsePrefix=function(){return this._usePrefix};
Downsha.Logger.prototype.setUsePrefix=function(a){this._usePrefix=a?!0:!1};Downsha.Logger.prototype.isUseTimestamp=function(){return this._useTimestamp};Downsha.Logger.prototype.setUseTimestamp=function(a){this._useTimestamp=a?!0:!1};Downsha.Logger.prototype.isEnabled=function(){return this._enabled};Downsha.Logger.prototype.setEnabled=function(a){this._enabled=a?!0:!1};Downsha.Logger.prototype.isDebugEnabled=function(){return this.enabled&&this.level<=Downsha.Logger.LOG_LEVEL_DEBUG};
Downsha.Logger.prototype.dump=function(a){this.enabled&&this.impl.enabled&&this.impl.dir(a)};Downsha.Logger.prototype.dir=function(a){this.enabled&&this.impl.enabled&&this.impl.dir(a)};Downsha.Logger.prototype.trace=function(){this.enabled&&this.impl.enabled&&this.impl.trace()};Downsha.Logger.prototype.alert=function(a){this.enabled&&this.impl.enabled&&this.impl.alert(a)};
Downsha.Logger.prototype.debug=function(a){this.enabled&&this.impl.enabled&&this.level<=Downsha.Logger.LOG_LEVEL_DEBUG&&this.impl.debug(this.getPrefix(this.constructor.DEBUG_PREFIX)+a)};Downsha.Logger.prototype.info=function(a){this.enabled&&this.impl.enabled&&this.level<=Downsha.Logger.LOG_LEVEL_INFO&&this.impl.info(this.getPrefix(this.constructor.INFO_PREFIX)+a)};
Downsha.Logger.prototype.warn=function(a){this.enabled&&this.impl.enabled&&this.level<=Downsha.Logger.LOG_LEVEL_WARN&&this.impl.warn(this.getPrefix(this.constructor.WARN_PREFIX)+a)};Downsha.Logger.prototype.error=function(a){this.enabled&&this.impl.enabled&&this.level<=Downsha.Logger.LOG_LEVEL_ERROR&&this.impl.error(this.getPrefix(this.constructor.ERROR_PREFIX)+a)};
Downsha.Logger.prototype.exception=function(a){this.enabled&&this.impl.enabled&&this.level<=Downsha.Logger.LOG_LEVEL_EXCEPTION&&this.impl.exception(this.getPrefix(this.constructor.EXCEPTION_PREFIX)+a)};Downsha.Logger.prototype.clear=function(){this.impl.clear()};
Downsha.LoggerImpl=function(a){this.__defineGetter__("logger",this.getLogger);this.__defineSetter__("logger",this.setLogger);this.__defineGetter__("enabled",this.isEnabled);this.__defineSetter__("enabled",this.setEnabled);this.__defineGetter__("protoEnabled",this.isProtoEnabled);this.__defineSetter__("protoEnabled",this.setProtoEnabled);this.initialize(a)};Downsha.LoggerImpl.ClassRegistry=[];Downsha.LoggerImpl.isResponsibleFor=function(){return!1};Downsha.LoggerImpl.prototype.handleInheritance=function(a){Downsha.LoggerImpl.ClassRegistry.push(a)};
Downsha.LoggerImpl.prototype._logger=null;Downsha.LoggerImpl.prototype._enabled=!1;Downsha.LoggerImpl.prototype.initialize=function(a){this.logger=a};Downsha.LoggerImpl.prototype.answerImplementorInstance=function(a){if(this.constructor==a)return this};Downsha.LoggerImpl.prototype.isEnabled=function(){return this._enabled};Downsha.LoggerImpl.prototype.setEnabled=function(a){this._enabled=a?!0:!1};Downsha.LoggerImpl.prototype.isProtoEnabled=function(){return this.constructor.prototype._enabled};
Downsha.LoggerImpl.prototype.setProtoEnabled=function(a){this.constructor.prototype._enabled=a?!0:!1};Downsha.LoggerImpl.prototype.getLogger=function(){return this._logger};Downsha.LoggerImpl.prototype.setLogger=function(a){a instanceof Downsha.Logger&&(this._logger=a)};Downsha.LoggerImpl.prototype.dir=function(){};Downsha.LoggerImpl.prototype.trace=function(){};Downsha.LoggerImpl.prototype.debug=function(){};Downsha.LoggerImpl.prototype.info=function(){};Downsha.LoggerImpl.prototype.warn=function(){};
Downsha.LoggerImpl.prototype.error=function(){};Downsha.LoggerImpl.prototype.exception=function(){};Downsha.LoggerImpl.prototype.alert=function(){};Downsha.LoggerImpl.prototype.clear=function(){};Downsha.LoggerChainImpl=function(a,b){this.initialize(a,b)};Downsha.inherit(Downsha.LoggerChainImpl,Downsha.LoggerImpl,!0);Downsha.LoggerChainImpl.prototype._impls=null;Downsha.LoggerChainImpl.prototype._enabled=!0;
Downsha.LoggerChainImpl.prototype.initialize=function(a,b){Downsha.LoggerChainImpl.parent.initialize.apply(this,[a]);var c=[].concat(b);this._impls=[];for(var d=0;d<c.length;d++)this._impls.push(new c[d](a))};Downsha.LoggerChainImpl.prototype.answerImplementorInstance=function(a){for(var b=0;b<this._impls.length;b++){var c=this._impls[b].answerImplementorInstance(a);if(c)return c}};Downsha.LoggerChainImpl.prototype.dir=function(a){for(var b=0;b<this._impls.length;b++)this._impls[b].enabled&&this._impls[b].dir(a)};
Downsha.LoggerChainImpl.prototype.trace=function(){for(var a=0;a<this._impls.length;a++)this._impls[a].enabled&&this._impls[a].trace(obj)};Downsha.LoggerChainImpl.prototype.debug=function(a){for(var b=0;b<this._impls.length;b++)this._impls[b].enabled&&this._impls[b].debug(a)};Downsha.LoggerChainImpl.prototype.info=function(a){for(var b=0;b<this._impls.length;b++)this._impls[b].enabled&&this._impls[b].info(a)};
Downsha.LoggerChainImpl.prototype.warn=function(a){for(var b=0;b<this._impls.length;b++)this._impls[b].enabled&&this._impls[b].warn(a)};Downsha.LoggerChainImpl.prototype.error=function(a){for(var b=0;b<this._impls.length;b++)this._impls[b].enabled&&this._impls[b].error(a)};Downsha.LoggerChainImpl.prototype.exception=function(a){for(var b=0;b<this._impls.length;b++)this._impls[b].enabled&&this._impls[b].exception(a)};
Downsha.LoggerChainImpl.prototype.alert=function(a){for(var b=0;b<this._impls.length;b++)this._impls[b].enabled&&this._impls[b].alert(a)};Downsha.LoggerChainImpl.prototype.clear=function(){for(var a=0;a<this._impls.length;a++)this._impls[a].enabled&&this._impls[a].clear()};
Downsha.LoggerImplFactory={getImplementationFor:function(a){for(var b=Downsha.LoggerImpl.ClassRegistry,c=[],d=0;d<b.length;d++)"function"==typeof b[d]&&"function"==typeof b[d].isResponsibleFor&&b[d].isResponsibleFor(a)&&c.push(b[d]);return 0==c.length?Downsha.LoggerImpl:1==c.length?c[0]:c}};Downsha.WebKitLoggerImpl=function(a){this.initialize(a)};Downsha.inherit(Downsha.WebKitLoggerImpl,Downsha.LoggerImpl,!0);Downsha.WebKitLoggerImpl.isResponsibleFor=function(a){return 0<=a.userAgent.toLowerCase().indexOf("AppleWebKit/")};
Downsha.WebKitLoggerImpl.prototype._enabled=!0;Downsha.WebKitLoggerImpl.prototype.dir=function(a){console.group(this.logger.scopeName);console.dir(a);console.groupEnd()};Downsha.WebKitLoggerImpl.prototype.trace=function(){console.group(this.logger.scopeName);console.trace();console.groupEnd()};Downsha.WebKitLoggerImpl.prototype.alert=function(a){alert(a)};Downsha.WebKitLoggerImpl.prototype.debug=function(a){console.debug(a)};Downsha.WebKitLoggerImpl.prototype.info=function(a){console.info(a)};
Downsha.WebKitLoggerImpl.prototype.warn=function(a){console.warn(a)};Downsha.WebKitLoggerImpl.prototype.error=function(a){console.error(a)};Downsha.WebKitLoggerImpl.prototype.exception=function(a){console.error(a);this.trace()};Downsha.ChromeExtensionLoggerImpl=function(a){this.initialize(a)};Downsha.inherit(Downsha.ChromeExtensionLoggerImpl,Downsha.WebKitLoggerImpl,!0);Downsha.ChromeExtensionLoggerImpl.isResponsibleFor=function(a){return 0<=a.userAgent.toLowerCase().indexOf("chrome/")};
Downsha.ChromeExtensionLoggerImpl.prototype._enabled=!0;Downsha.Utils=new function(){};Downsha.Utils.extendObject=function(a,b,c,d){if("object"==typeof a&&null!=a&&"object"==typeof b&&null!=b)for(var e in b)"undefined"==typeof a[e]||d?a[e]=b[e]:c&&arguments.callee.apply(this,[a[e],b[e],c,d])};
Downsha.Utils.importConstructs=function(a,b,c){for(var c=c instanceof Array?c:[c],d=0;d<c.length;d++)for(var e=c[d].split("."),f=b,g=a,h=0;h<e.length;h++)h==e.length-1?"undefined"==typeof f[e[h]]?f[e[h]]=g[e[h]]:Downsha.Utils.extendObject(f[e[h]],g[e[h]],!0):(g=g[e[h]],"undefined"==typeof f[e[h]]&&(f[e[h]]={}),f=f[e[h]])};
Downsha.Utils.separateString=function(a,b){if("string"!=typeof a)return a;"string"!=typeof b&&(b=",");for(var c=a.split(b),d=[],e=0;e<c.length;e++)if("string"==typeof c[e]){var f=Downsha.Utils.trim(c[e]);f&&0<f.length&&d.push(f)}return d};Downsha.Utils.trim=function(a){return"string"!=typeof a?a:a.replace(/^\s+/,"").replace(/\s+$/,"")};Downsha.Utils.shortenString=function(a,b,c){a+="";a.length>b&&(a=a.substring(0,Math.max(0,b-("string"==typeof c?c.length:0))),"string"==typeof c&&(a+=c));return a};
Downsha.Utils.htmlEntities=function(a){return $("<div/>").text(a).html()};Downsha.Utils.urlPath=function(a){return"string"==typeof a&&(a=a.replace(/^[^:]+:\/+([^\/]+)/,""),0==a.indexOf("/"))?a.replace(/^(\/[^\?\#]*).*$/,"$1"):""};Downsha.Utils.urlDomain=function(a,b){return"string"==typeof a?a.replace(RegExp("^[^:]+:/+([^/"+(b?"":":")+"]+).*$"),"$1"):a};
Downsha.Utils.urlTopDomain=function(a){var b=a;"string"==typeof a&&(b=Downsha.Utils.urlDomain(a),0==b.toLowerCase().indexOf("www.")&&(b=b.substring(4)));return b};Downsha.Utils.urlPath=function(a){return"string"==typeof a?a.replace(/^[^:]+:\/\/[^/]+([^&?]*).*$/,"$1"):""};
Downsha.Utils.urlQueryValue=function(a,b){if("string"==typeof b&&"string"==typeof a&&0<=b.indexOf("?")){for(var c=b.split(/[\?\#\&]+/).slice(1),d=a.toLowerCase(),e=[],f=0;f<c.length;f++){var g=c[f].split("=",2);g[0].toLowerCase()==d&&(g=g[1]?g[1].replace(/\+/g," "):g[1],e.push(decodeURIComponent(g)))}if(0<e.length)return e[e.length-1]}return null};Downsha.Utils.urlProto=function(a){if("string"==typeof a){var b=-1;if(0<(b=a.indexOf(":/")))return a.substring(0,b).toLowerCase()}return null};
Downsha.Utils.absoluteUrl=function(a,b){0==a.indexOf("//")?a=b.replace(/^([^:]+):.*$/,"$1")+":"+a:0==a.indexOf("/")?a=b.replace(/^(.*:\/\/[^\/]+).*$/,"$1")+a:(a.match(/^\.+\//),a="/"==b.charAt(b.length-1)?b+a:b+"/"+a);return a};Downsha.Utils.urlSuffix="...";
Downsha.Utils.shortUrl=function(a,b){var c=a;"string"==typeof a&&(0==c.indexOf("file:")?(c=decodeURIComponent(c.replace(/^file:.*\/([^\/]+)$/,"$1")),"number"==typeof b&&!isNaN(b)&&c.length>b&&(c=c.substring(0,b),c+=""+Downsha.Utils.urlSuffix)):(c=c.replace(/^([a-zA-Z]+:\/+)?([^\/]+).*$/,"$2"),"number"==typeof b&&!isNaN(b)&&c.length>b?(c=c.substring(0,b),c+=""+Downsha.Utils.urlSuffix):2<a.substring(a.indexOf(c)+c.length).length&&(c+="/"+Downsha.Utils.urlSuffix)));return c};
Downsha.Utils.getDocumentWidth=function(a){a||(a=document);return a.width?a.width:a.body&&a.documentElement&&a.documentElement.scrollWidth?a.documentElement.scrollWidth:a.body&&a.body.scrollWidth?a.body.scrollWidth:0};Downsha.Utils.getDocumentHeight=function(a){a||(a=document);return a.height?a.height:a.body&&a.body.scrollHeight&&a.documentElement&&a.documentElement.scrollHeight?Math.max(a.documentElement.scrollHeight,a.body.scrollHeight):a.body&&a.body.scrollHeight?a.body.scrollHeight:0};
Downsha.Utils.findEmbeds=function(a){var b=[];try{var c=a.getElementsByTagName("object");if(c&&0<c.length)for(var d=0;d<c.length;d++)b.push(c[d]);var e=a.getElementsByTagName("embed");if(e&&0<e.length)for(d=0;d<e.length;d++)b.push(e[d])}catch(f){}return b};
Downsha.Utils.findDocuments=function(a){var b=[];try{var c=a.getElementsByTagName("frame");if(c&&0<c.length)for(var d=0;d<c.length;d++)c[d].contentDocument?b.push(c[d].contentDocument):c[d].contentWindow&&c[d].contentWindow.document?b.push(c[d].contentWindow.document):c[d].document&&b.push(c[d].document);var e=a.getElementsByTagName("iframe");if(e&&0<e.length)for(d=0;d<e.length;d++)e[d].contentDocument?b.push(e[d].contentDocument):e[d].contentWindow&&e[d].contentWindow.document?b.push(e[d].contentWindow.document):
e[d].document&&b.push(e[d].document)}catch(f){}return b};Downsha.Utils.getDocumentHead=function(a){return a.head?a.head:a.getElementsByTagName("head")?a.getElementsByTagName("head")[0]:a.documentElement?a.documentElement:a.body&&a.body.parentNode?a.body.parentNode:null};Downsha.Utils.makeAbsoluteClientRect=function(a,b){b||(b=window);return{top:a.top+b.pageYOffset,bottom:a.bottom+b.pageYOffset,left:a.left+b.pageXOffset,right:a.right+b.pageXOffset,width:a.width,height:a.height}};
Downsha.Utils.getAbsoluteBoundingClientRect=function(a){var b=a&&a.nodeType==Node.TEXT_NODE?a.parentElement?a.parentElement:a.parentNode:a;if(!b)return null;a=a instanceof Range?a.commonAncestorContainer.ownerDocument.defaultView:a.ownerDocument.defaultView;return Downsha.Utils.makeAbsoluteClientRect(b.getBoundingClientRect(),a)};Downsha.Utils.getElementForNode=function(a){return a&&a.nodeType==Node.ELEMENT_NODE?a:a.parentElement?a.parentElement:null};
Downsha.Utils.addElementClass=function(a,b){if(a&&b){var c=a.getAttribute("class");c?(c=c.split(/\s+/),0>c.indexOf(b)&&c.push(b),a.setAttribute("class",c.join(" "))):a.setAttribute("class",b)}};Downsha.Utils.removeElementClass=function(a,b){if(b){var c=a.getAttribute("class");if(c){var c=c.split(/\s+/),d=-1;0<=(d=c.indexOf(b))&&c.splice(d,1);a.setAttribute("class",c.join(" "))}}};Downsha.Utils.XML_ESCAPE_CHAR_MAP={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&apos;"};
Downsha.Utils.escapeXML=function(a){for(var a=a.split(""),b=0;b<a.length;b++)Downsha.Utils.XML_ESCAPE_CHAR_MAP[a[b]]&&(a[b]=Downsha.Utils.XML_ESCAPE_CHAR_MAP[a[b]]);return a.join("")};
Downsha.Utils.escapeURL=function(a){for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);if(128>d)b+=String.fromCharCode(d);else if(2048>d)var e=d>>6|192,f=d&63|128,b=b+("%"+e.toString(16).toUpperCase()),b=b+("%"+f.toString(16).toUpperCase());else 65536>d&&(e=d>>12|224,f=d>>6&63|128,d=d&63|128,b+="%"+e.toString(16).toUpperCase(),b+="%"+f.toString(16).toUpperCase(),b+="%"+d.toString(16).toUpperCase())}return b};
Downsha.Utils.rectIntersection=function(a,b){if(!(b.left>a.right||b.right<a.left||b.top>a.bottom||b.bottom<a.top)){var c={left:Math.max(a.left,b.left),top:Math.max(a.top,b.top),right:Math.min(a.right,b.right),bottom:Math.min(a.bottom,b.bottom)};c.width=c.right-c.left;c.height=c.bottom-c.top;return c}};Downsha.Utils.rectsEqual=function(a,b){return a.left==b.left&&a.right==b.right&&a.top==b.top&&a.bottom==b.bottom?!0:!1};
Downsha.Utils.expandRect=function(a,b){a.left="number"==typeof a.left?Math.min(a.left,b.left):b.left;a.top="number"==typeof a.top?Math.min(a.top,b.top):b.top;a.right="number"==typeof a.right?Math.max(a.right,b.right):b.right;a.bottom="number"==typeof a.bottom?Math.max(a.bottom,b.bottom):b.bottom};
Downsha.Utils.errorDescription=function(a){var b=null;if(a instanceof FileError){var c=a.code;if("number"==typeof c)for(var d in FileError){if(0<d.toLowerCase().indexOf("_err")&&FileError[d]==a.code){b="FileError: "+c+" ("+d+")";break}}else b="FileError: "+c}else a.message?b=a.message:"undefined"!=typeof a.code&&(b=(a.constructor&&a.constructor.name?a.constructor.name:""+a)+" code: "+a.code);return b};
Downsha.UUID={generateQuad:function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},generateGuid:function(){return this.generateQuad()+this.generateQuad()+"-"+this.generateQuad()+"-"+this.generateQuad()+"-"+this.generateQuad()+"-"+this.generateQuad()+this.generateQuad()+this.generateQuad()}};Downsha.Utils=Downsha.Utils||new function(){};Downsha.Utils.MIN_ARTICLE_RATIO=0.0625;Downsha.Utils.MIN_ARTICLE_AREA=3E4;Downsha.Utils.MAX_ARTICLE_XOFFSET_RATIO=0.6;
Downsha.Utils.querySelectors=function(a,b){var c=null;if(!a)return c;for(var b=b||document,d=0;d<a.length;d++){c=a[d];if(":root"===c)return b;if(c=b.querySelector(c))break}return c};
Downsha.Utils.getArticleNode=function(a,b){a=a||document;if(!a)return null;var c=null;if(b&&b.a){var d=Downsha.Utils.querySelectors(b.a,a);d&&(c=d)}if(!c){var d=["jpeg","jpg","gif","png"],e=a.location.href.replace(/^.*\.(\w+)$/,"$1");e&&-1!=d.indexOf(e)&&(d=a.querySelector("body > img"))&&(c=d)}if(!c&&"frameset"==a.body.nodeName.toLowerCase()){for(var e=a.getElementsByTagName("frame"),d=null,f=0,g=0,h=0;h<e.length;h++)e[h].width&&e[h].height&&(f=e[h].width*e[h].height,f>g&&(d=e[h],g=f));d&&d.contentDocument&&
d.contentDocument.documentElement&&(c=d.contentDocument.documentElement)}c||(d=new ExtractContentJS.LayeredExtractor,d.addHandler(d.factory.getHandler("Heuristics")),d=d.extract(a),d.isSuccess&&(d=d.content.asNode(),c=Downsha.Utils.getElementForNode(d)));return c};Downsha.Utils.isArticleSane=function(a,b,c){if(a&&b&&c){var d=c.width*c.height;if(!(c.top>b*Downsha.Utils.MAX_ARTICLE_XOFFSET_RATIO)&&!(d<Downsha.Utils.MIN_ARTICLE_AREA&&d<a*b*Downsha.Utils.MIN_ARTICLE_RATIO))return!0}return!1};
Downsha.Utils.MESSAGE_ATTR="message";Downsha.Utils.PLACEHOLDER_ATTR="placeholder";Downsha.Utils.TITLE_ATTR="title";Downsha.Utils.MESSAGE_DATA_ATTR="messagedata";Downsha.Utils.LOCALIZED_ATTR="localized";Downsha.Utils.BADGE_NORMAL_COLOR=[255,0,0,255];Downsha.Utils.BADGE_UPLOADING_COLOR=[255,255,0,255];Downsha.Utils.updateBadge=function(a,b){Downsha.Utils.clearBadge(b);Downsha.Utils.setBadgeTitle(chrome.i18n.getMessage("BrowserActionTitle"),b)};
Downsha.Utils.clearBadge=function(a){var b={text:""};"number"==typeof a?this.doInSpecifiedTab(a,function(){b.tabId=a;chrome.browserAction.setBadgeText(b)}):this.clearAllBadges()};Downsha.Utils.clearAllBadges=function(){this.doInEveryNormalTab(function(a){chrome.browserAction.setBadgeText({tabId:a.id,text:""})},!0)};
Downsha.Utils.setBadgeBackgroundColor=function(a,b){var c={color:a};"number"==typeof b?this.doInSpecifiedTab(b,function(){c.tabId=b;chrome.browserAction.setBadgeBackgroundColor(c)}):this.doInEveryNormalTab(function(a){c.tabId=a.id;chrome.browserAction.setBadgeBackgroundColor(c)},!0)};
Downsha.Utils.setBadgeText=function(a,b){if(a){var c={text:""+a};"number"==typeof b?this.doInSpecifiedTab(b,function(){c.tabId=b;chrome.browserAction.setBadgeText(c)}):this.doInEveryNormalTab(function(a){c.tabId=a.id;chrome.browserAction.setBadgeText(c)},!0)}else null==a&&Downsha.Utils.clearBadge(b)};
Downsha.Utils.setBadgeTitle=function(a,b){if(a){var c={title:""+a};"number"==typeof b?this.doInSpecifiedTab(b,function(){c.tabId=b;chrome.browserAction.setTitle(c)}):this.doInEveryNormalTab(function(a){c.tabId=a.id;chrome.browserAction.setTitle(c)},!0)}else null==a&&Downsha.Utils.clearBadgeTitle(b)};
Downsha.Utils.clearBadgeTitle=function(a){var b={title:""};"number"==typeof a?this.doInSpecifiedTab(a,function(){b.tabId=a;chrome.browserAction.setTitle(b)}):this.doInEveryNormalTab(function(a){b.tabId=a.id;chrome.browserAction.setTitle(b)},!0)};Downsha.Utils.doInSpecifiedTab=function(a,b){"number"==typeof a&&chrome.tabs.get(a,function(a){"undefined"!=typeof a&&null!=a&&b()})};
Downsha.Utils.doInEveryNormalTab=function(a,b){chrome.windows.getAll({populate:!0},function(c){for(var d=0;d<c.length;d++)if("normal"==c[d].type)for(var e=0;e<c[d].tabs.length;e++)(!b||c[d].tabs[e].selected)&&a(c[d].tabs[e],c[d])})};
Downsha.Utils.localizeBlock=function(a){a.attr(Downsha.Utils.MESSAGE_ATTR)&&Downsha.Utils.localizeElement(a);for(var a=a.find("["+Downsha.Utils.MESSAGE_ATTR+"], ["+Downsha.Utils.PLACEHOLDER_ATTR+"], ["+Downsha.Utils.TITLE_ATTR+"]"),b=0;b<a.length;b++){var c=$(a.get(b));Downsha.Utils.localizeElement(c)}};Downsha.Utils.extractLocalizationField=function(a){return"function"==typeof a.attr&&a.attr(Downsha.Utils.MESSAGE_ATTR)?a.attr(Downsha.Utils.MESSAGE_ATTR):null};
Downsha.Utils.extractLocalizationDataField=function(a){if("function"==typeof a.attr&&a.attr(Downsha.Utils.MESSAGE_DATA_ATTR)){a=a.attr(Downsha.Utils.MESSAGE_DATA_ATTR);try{a=eval(a)}catch(b){}a instanceof Array||(a=[a]);return a}return null};Downsha.Utils.extractLocalizationPlaceholderField=function(a){return"function"==typeof a.attr&&a.attr(Downsha.Utils.PLACEHOLDER_ATTR)?a.attr(Downsha.Utils.PLACEHOLDER_ATTR):null};
Downsha.Utils.extractLocalizationTitleField=function(a){return"function"==typeof a.attr&&a.attr(Downsha.Utils.TITLE_ATTR)?a.attr(Downsha.Utils.TITLE_ATTR):null};
Downsha.Utils.localizeElement=function(a,b){if(b||!(a.attr(Downsha.Utils.LOCALIZED_ATTR)&&"true"==a.attr(Downsha.Utils.LOCALIZED_ATTR))){var c=Downsha.Utils.extractLocalizationField(a),d=Downsha.Utils.extractLocalizationPlaceholderField(a),e=Downsha.Utils.extractLocalizationTitleField(a),f=Downsha.Utils.extractLocalizationDataField(a),g=!1;"string"==typeof c&&""!=c&&(c=f?chrome.i18n.getMessage(c,f):chrome.i18n.getMessage(c),"INPUT"==a.prop("tagName")?a.val(c):a.html(c),g=!0);"string"==typeof d&&""!=
d&&(c=chrome.i18n.getMessage(d),a.attr(Downsha.Utils.PLACEHOLDER_ATTR,c),g=!0);"string"==typeof e&&""!=e&&(c=chrome.i18n.getMessage(e),a.attr(Downsha.Utils.TITLE_ATTR,c),g=!0);g&&a.attr(Downsha.Utils.LOCALIZED_ATTR,"true")}};Downsha.Utils.notifyExtension=function(a,b){chrome.windows.getCurrent(function(c){chrome.tabs.getSelected(c.id,function(c){var c={tab:c,id:chrome.i18n.getMessage("@@extension_id")},e=b||function(){};chrome.extension.onRequest.dispatch(a,c,e);chrome.extension.sendRequest(a,e)})})};
Downsha.Utils._setDesktopNotificationAttributes=function(a,b){if(a&&"object"==typeof b&&b)for(var c in b)a[c]=b[c]};Downsha.Utils.notifyDesktop=function(a,b,c,d){var e=webkitNotifications.createNotification("images/downsha48.png",a,b);this._setDesktopNotificationAttributes(e,d);e.show();"number"==typeof c&&setTimeout(function(){e.cancel()},c);return e};
Downsha.Utils.notifyDesktopWithHTML=function(a,b,c){var d=webkitNotifications.createHTMLNotification(a);this._setDesktopNotificationAttributes(d,c);d.show();"number"==typeof b&&setTimeout(function(){d.cancel()},b);return d};Downsha.Utils.openWindow=function(a){chrome.extension.getBackgroundPage().Downsha.chromeExtension.openWindow(a)};
Downsha.Utils.getPostData=function(a){"undefined"==typeof a&&(a=window.location.search.replace(/^\?/,""));var b={};if(a)for(var a=a.split("&"),c=0;c<a.length;c++){var d=a[c].split("="),e=unescape(d[0]);if(d=d[1]?unescape(d[1]):null)try{b[e]=JSON.parse(d)}catch(f){b[e]=d}else b[e]=d}return b};
Downsha.Utils.isForbiddenUrl=function(a){return"string"==typeof a&&(0<=a.toLowerCase().indexOf("chrome.google.com/extensions")||0<=a.toLowerCase().indexOf("chrome.google.com/webstore")||0<=a.toLowerCase().indexOf("ext.chrome.360.cn"))||"string"==typeof a&&!a.toLowerCase().match(/^https?:\/\//)?!0:!1};
Downsha.Utils.getTextSize=function(a){var b=$("<div></div>");b.text(a);b.css({position:"absolute",top:"0px",left:"0px",padding:"0px",margin:"0px",display:"block",zIndex:"0",color:"rgba(0, 0, 0, 0)",background:"rgba(0, 0, 0, 0)"});$("body").append(b);a={width:b.width(),height:b.height()};b.remove();return a};
Downsha.Utils.updateSelectElementWidth=function(a,b){var c=a instanceof jQuery?a:$(a),d=c.val();"function"==typeof b&&(d=b(d));var e=parseInt(c.css("paddingLeft")),f=parseInt(c.css("paddingRight")),e=(!isNaN(e)?e:0)+(!isNaN(f)?f:0),d=Downsha.Utils.getTextSize(d).width,d=(d?d:0)+e+10;c.css({minWidth:d+"px",width:d+"px"})};
Downsha.Utils.resizeElement=function(a,b,c){var a=a instanceof jQuery?a:$(a),d={},e={};if(b&&"number"==typeof b.width){var f=parseInt(a.css("paddingLeft")),g=parseInt(a.css("paddingRight")),f=(!isNaN(f)?f:0)+(!isNaN(g)?g:0);e.width=b.width+f;d.minWidth=e.width+"px";d.width=e.width+"px"}b&&"number"==typeof b.height&&(f=parseInt(a.css("paddingTop")),g=parseInt(a.css("paddingBottom")),f=(!isNaN(f)?f:0)+(!isNaN(g)?g:0),e.height=b.height+f,d.minHeight=e.height+"px",css.height=e.height+"px");a.css(d);"function"==
typeof c&&c(a,e)};Downsha.Utils.BAD_FAV_ICON_URLS=["http://localhost/favicon.ico"];
Downsha.Utils.createUrlClipContent=function(a,b,c){a=a?Downsha.Utils.escapeXML(a):"";b='<a title="'+a+'" style="font-size: 12pt; line-height: 18px; display: inline;" href="'+b+'">'+b+"</a>";return b="string"==typeof c&&0<c.length&&0>Downsha.Utils.BAD_FAV_ICON_URLS.indexOf(c.toLowerCase())?'<span><img title="'+a+'" style="display:inline;border: none; width: 16px; height: 16px; padding: 0px; margin: 0px 8px -2px 0px;" src="'+c+'"/>'+b+"</span>":"<span>"+b+"</span>"};
Downsha.Utils.getNodeString=function(a){var b=null;if("object"!=typeof a||null==a)b="[null]";else if(a&&a.nodeType==Node.TEXT_NODE)b="string"==typeof a.nodeValue&&0<a.nodeValue.length?a.nodeName+" "+a.nodeValue:a.nodeName+" [empty]";else if(a&&a.nodeType==Node.ELEMENT_NODE){for(var b="<"+a.nodeName,a=a.attributes,c=0;c<a.length;c++)a[c]&&a[c].name&&a[c].specified&&(b=a[c].value?b+(" "+a[c].name+'="'+a[c].value+'"'):b+(" "+a[c].name));b+=">"}else b="node","string"==typeof a.nodeName&&0<a.nodeName.length&&
(b+=" name: "+a.nodeName),"number"==typeof a.nodeType&&(b+=" type: "+a.nodeType),"string"==typeof a.nodeValue&&0<a.nodeValue.length&&(b+=" value: "+a.nodeValue);return b};Downsha.Semaphore=function(a){this.__defineGetter__("excessSignals",this.getExcessSignals);this.initialize(a)};Downsha.inherit(Downsha.Semaphore,Array);Downsha.Semaphore.mutex=function(){var a=new Downsha.Semaphore;a.signal();return a};Downsha.Semaphore.prototype._excessSignals=0;
Downsha.Semaphore.prototype.initialize=function(a){this._excessSignals=parseInt(a);isNaN(this._excessSignals)&&(this._excessSignals=0)};Downsha.Semaphore.prototype.getExcessSignals=function(){return this._excessSignals};Downsha.Semaphore.prototype.hasExcessSignals=function(){return 0<this._excessSignals?!0:!1};Downsha.Semaphore.prototype.signal=function(){0==this.length?this._excessSignals++:this._processNext()};
Downsha.Semaphore.prototype.wait=function(){0<this._excessSignals&&(this._excessSignals--,this._processNext())};Downsha.Semaphore.prototype.critical=function(a){var b=this,c=function(){try{a()}catch(c){throw b.signal(),c;}};c._semaOrigFn=a;this.push(c);this.wait()};Downsha.Semaphore.prototype.wave=function(){0<this.length&&this.shift()};Downsha.Semaphore.prototype.waveAll=function(){0<this.length&&this.splice(0,this.length)};
Downsha.Semaphore.prototype.waveEach=function(a){for(var b=0;b<this.length;)a(this[b]._semaOrigFn)?this.splice(b,1):b++};Downsha.Semaphore.prototype._processNext=function(){if(0<this.length){var a=this.shift();"function"==typeof a&&a()}};Downsha.Semaphore.prototype.toString=function(){return this._excessSignals+":["+this.join(",")+"]"};
Downsha.XORCrypt={DELIMIT:":",LENGTH:128,_padString:function(a){var b=0;if(128>a.length)for(var c=a.length;128>=c;c++)a=String.fromCharCode(this._randomForChar())+a,b++;return b+this.DELIMIT+a},_randomForChar:function(){for(var a=0,b=0;33>a||126<a;)a=parseInt(150*Math.random()),b++;return a},_randomNonZero:function(){for(var a=0;0==(a=parseInt(100*Math.random())););return a},_shiftString:function(a){for(var b=this._randomNonZero()+100,c=[],d=0;d<a.length;d++)c.push(String.fromCharCode(a.charCodeAt(d)+
b));return b+this.DELIMIT+c.join("")},_unshiftString:function(a){var b=parseInt(a.substring(0,a.indexOf(this.DELIMIT))),c=[];if(!isNaN(b))for(var d=(b+"").length+this.DELIMIT.length;d<a.length;d++)c.push(String.fromCharCode(a.charCodeAt(d)-b));return c.join("")},encrypt:function(a,b){for(var b=b+"",c=this._padString(this._shiftString(a+"")),d=[],e=0;e<c.length;e++){for(var f=c.charCodeAt(e),g=0;g<b.length;g++)f^=b.charCodeAt(g);d.push(String.fromCharCode(f+100))}return d.join("")},decrypt:function(a,
b){for(var a=a+"",b=b+"",c=[],d=0;d<a.length;d++){for(var e=a.charCodeAt(d)-100,f=b.length-1;0<=f;f--)e^=b.charCodeAt(f);c.push(String.fromCharCode(e))}c=c.join("");d=parseInt(c.substring(0,c.indexOf(this.DELIMIT)));return!isNaN(d)?this._unshiftString(c.substring((""+d).length+this.DELIMIT.length+d)):""}};Downsha.Constants=Downsha.Constants||{};
Downsha.Constants.RequestType={UNKNOWN:0,LOGOUT:1001,LOGIN:1002,LOGIN_ERROR:1003,LOGIN_SUCCESS:1004,POPUP_STARTED:2001,POPUP_ENDED:2002,PAGE_CLIP_SUCCESS:3001,PAGE_CLIP_FAILURE:3002,PAGE_CLIP_CONTENT_SUCCESS:3003,PAGE_CLIP_CONTENT_FAILURE:3004,PAGE_CLIP_CONTENT_TOO_BIG:3005,CONTEXT_PAGE_CLIP_SUCCESS:3101,CONTEXT_PAGE_CLIP_FAILURE:3102,CONTEXT_PAGE_CLIP_CONTENT_SUCCESS:3103,CONTEXT_PAGE_CLIP_CONTENT_FAILURE:3104,CONTEXT_PAGE_CLIP_CONTENT_TOO_BIG:3105,CONTENT_SCRIPT_LOAD_TIMEOUT:4001,FETCH_STYLE_SHEET_RULES:4002,
CLIP_ACTION_FULL_PAGE:5001,CLIP_ACTION_ARTICLE:5002,CLIP_ACTION_SELECTION:5003,CLIP_ACTION_URL:5004,PREVIEW_CLIP_ACTION_CLEAR:6001,PREVIEW_CLIP_ACTION_FULL_PAGE:6002,PREVIEW_CLIP_ACTION_ARTICLE:6003,PREVIEW_CLIP_ACTION_SELECTION:6004,PREVIEW_CLIP_ACTION_URL:6005,PREVIEW_NUDGE:6101,PREVIEW_NUDGE_PREVIOUS_SIBLING:6102,PREVIEW_NUDGE_NEXT_SIBLING:6103,PREVIEW_NUDGE_PARENT:6104,PREVIEW_NUDGE_CHILD:6105,PAGE_INFO:7001,FETCH_ARTICLE_RULES:8001};
Downsha.Constants.Limits={DSTP_USER_NAME_LEN_MIN:6,DSTP_USER_NAME_LEN_MAX:16,DSTP_USER_NAME_REGEX:"^[A-Za-z0-9._\\-\\u4e00-\\u9fa5]{6,16}$",DSTP_USER_EMAIL_LEN_MIN:6,DSTP_USER_EMAIL_LEN_MAX:255,DSTP_USER_EMAIL_REGEX:"^\\w+((-\\w+)|(\\.\\w+))*\\@[A-Za-z0-9]+((\\.|-)[A-Za-z0-9]+)*\\.[A-Za-z0-9]+$",DSTP_USER_PWD_LEN_MIN:6,DSTP_USER_PWD_LEN_MAX:16,DSTP_USER_PWD_REGEX:"^[A-Za-z0-9.~!@#$%^&*()+=_-]{6,16}$",DSTP_NOTE_TITLE_LEN_MIN:0,DSTP_NOTE_TITLE_LEN_MAX:127,DSTP_NOTE_TITLE_REGEX:"^$|^[^\\s\\r\\n\\t]([^\\n\\r\\t]{0,253}[^\\s\\r\\n\\t])?$",
DSTP_TAG_NAME_LEN_MIN:1,DSTP_TAG_NAME_LEN_MAX:100,DSTP_TAG_NAME_REGEX:"^[^,\\s\\r\\n\\t]([^,\\n\\r\\t]{0,98}[^,\\s\\r\\n\\t])?$",DSTP_NOTE_TAGS_MIN:0,DSTP_NOTE_TAGS_MAX:100,SERVICE_DOMAIN_LEN_MIN:1,SERVICE_DOMAIN_LEN_MAX:256,CLIP_NOTE_CONTENT_LEN_MAX:5242880};if("undefined"==typeof ExtractContentJS)var ExtractContentJS={};"undefined"==typeof ExtractContentJS.Lib&&(ExtractContentJS.Lib={});
ExtractContentJS.Lib.Util=function(){var a={BenchmarkTimer:function(){var a=function(){var a=new Date,b=0,b=a.getHours(),b=b*60+a.getMinutes(),b=b*60+a.getSeconds();return b=b*1E3+a.getMilliseconds()},c=function(){var c={elapsed:0,reset:function(){c.elapsed=0;return c},start:function(){c.msec=a();return c},stop:function(){c.elapsed=c.elapsed+(a()-c.msec);return c}};return c.start()},d={timers:{},get:function(a){d.timers[a]||(d.timers[a]=new c);return d.timers[a]},reset:function(a){return d.get(a).reset()},
start:function(a){return d.get(a).start()},stop:function(a){return d.get(a).stop()}};return d},Token:function(a){var c={hiragana:/[\u3042-\u3093\u304C-\u307C\u3041-\u3087\u308E\u3063\u30FC]/,katakana:/[\u30A2-\u30F3\u30AC-\u30DC\u30A1-\u30E7\u30EE\u30C3\u30FC]/,kanji:{test:function(a){return"\u4e00"<=a&&a<="\u9fa0"||a==="\u3005"}},alphabet:/[a-zA-Z]/,digit:/[0-9]/},d=function(a){var b={},d;for(d in c)c[d].test(a)&&(b[d]=c[d]);return b},e={first:d(a.charAt(0)),last:d(a.charAt(a.length-1)),isTokenized:function(a,
b){var c=a.length?a.charAt(a.length-1):"",d=b.length?b.charAt(0):"",j=function(a,b){if(a.length)for(var c in b)if(b[c].test(a))return false;return true};return j(c,e.first)&&j(d,e.last)}};return e},inherit:function(a,c){var d=a||{},e;for(e in c)typeof d[e]=="undefined"&&(d[e]=c[e]);return d},countMatch:function(a,c){return a.split(c).length-1},countMatchTokenized:function(b,c){for(var d=0,e=null,f=new a.Token(c),g=b.split(c),h=g.length,i=0;i<h;i++){e&&f.isTokenized(e,g[i])&&d++;e=g[i]}return d},indexOfTokenized:function(b,
c){var d=b.indexOf(c);if(d>=0){var e=new a.Token(c),f=d>1?b.substr(d-1,1):"",g=b.substr(d+c.length,1);if(e.isTokenized(f,g))return d}return-1},dump:function(a){if(typeof a=="undefined")return"undefined";if(typeof a=="string")return'"'+a+'"';if(typeof a!="object")return""+a;if(a===null)return"null";if(a instanceof Array)return"["+a.map(function(){return"obj"}).join(",")+"]";var c=[],d;for(d in a)c.push(d+":obj");return"{"+c.join(",")+"}"}};return a}();
ExtractContentJS.Lib.A=function(){var a={};a.indexOf=Array.indexOf||function(a,c){var d=2,e=a.length,d=Number(arguments[d++])||0,d=d<0?Math.ceil(d):Math.floor(d);for(d<0&&(d=d+e);d<e;d++)if(d in a&&a[d]===c)return d;return-1};a.filter=Array.filter||function(a,c){var d=2,e=a.length;if(typeof c!="function")throw new TypeError("A.filter: not a function");for(var f=[],d=arguments[d++],g=0;g<e;g++)if(g in a){var h=a[g];c.call(d,h,g,a)&&f.push(h)}return f};a.forEach=Array.forEach||function(a,c){var d=2,
e=a.length;if(typeof c!="function")throw new TypeError("A.forEach: not a function");for(var d=arguments[d++],f=0;f<e;f++)f in a&&c.call(d,a[f],f,a)};a.every=Array.every||function(a,c){var d=2,e=a.length;if(typeof c!="function")throw new TypeError("A.every: not a function");for(var d=arguments[d++],f=0;f<e;f++)if(f in a&&!c.call(d,a[f],f,a))return false;return true};a.map=Array.map||function(a,c){var d=2,e=a.length;if(typeof c!="function")throw new TypeError("A.map: not a function");for(var f=Array(e),
d=arguments[d++],g=0;g<e;g++)g in a&&(f[g]=c.call(d,a[g],g,a));return f};a.some=Array.some||function(a,c){var d=2,e=a.length;if(typeof c!="function")throw new TypeError("A.some: not a function");for(var d=arguments[d++],f=0;f<e;f++)if(f in a&&c.call(d,a[f],f,a))return true;return false};a.reduce=Array.reduce||function(a,c){var d=2,e=a.length;if(typeof c!="function")throw TypeError("A.reduce: not a function ");var f=0;if(arguments.length>d)var g=arguments[d++];else{do{if(f in a){g=a[f++];break}if(++f>=
e)throw new TypeError("A.reduce: empty array");}while(1)}for(;f<e;f++)f in a&&(g=c.call(null,g,a[f],f,a));return g};a.zip=function(a){if(a[0]instanceof Array){for(var c=a[0].length,d=a.length,e=Array(c),f=0;f<c;f++){e[f]=[];for(var g=0;g<d;g++)e[f].push(a[g][f])}return e}return[]};a.first=function(a){return a?a[0]:null};a.last=function(a){return a?a[a.length-1]:null};a.push=function(a,c){return Array.prototype.push.apply(a,c)};return a}();
ExtractContentJS.Lib.DOM=function(){var a=ExtractContentJS.Lib.A,b={getElementStyle:function(a,b){var e=a.style?a.style[b]:null;if(!e){var f=a.ownerDocument.defaultView;if(f&&f.getComputedStyle){try{var g=f.getComputedStyle(a,null)}catch(h){return null}b=b.replace(/([A-Z])/g,"-$1").toLowerCase();e=g?g.getPropertyValue(b):null}else a.currentStyle&&(e=a.currentStyle[b])}return e},text:function(a){return typeof a.textContent!="undefined"?a.textContent:a.nodeName=="#text"?a.nodeValue:typeof a.innerText!=
"undefined"?a.innerText:null},ancestors:function(a){for(var b=a.ownerDocument.body,e=[];a!=b;){e.push(a);a=a.parentNode}e.push(b);return e},commonAncestor:function(a,d){for(var e=b.ancestors(a).reverse(),f=b.ancestors(d).reverse(),g=null,h=0;e[h]&&f[h]&&e[h]==f[h];h++)g=e[h];return g},countMatchTagAttr:function(c,d,e,f){var g=function(a){return a.test(c[e])};if((c.tagName||"").toLowerCase()==d&&a.some(f,g))return 1;for(var g=0,h=c.childNodes,i=0,j=h.length;i<j;i++)g=g+b.countMatchTagAttr(h[i],d,e,
f);return g},matchTag:function(c,d){return a.some(d,function(a){return typeof a=="string"?a==(c.tagName||"").toLowerCase():a instanceof Array?a[0]==(c.tagName||"").toLowerCase()&&b.matchAttr(c,a[1]):false})},matchAttr:function(c,d){var e=function(d,f){if(typeof d=="string")return d==f;if(d instanceof RegExp)return d.test(f);if(d instanceof Array)return a.some(d,function(a){return e(a,f)});if(d instanceof Object)for(var g in d){var h=c[g];if(h&&b.matchAttr(h,d[g]))return true}return false},f;for(f in d){var g=
c[f],h=d[f];if(g)return e(h,g)}return false},matchStyle:function(c,d){var e=function(c,b){return typeof c=="string"?c==b:c instanceof RegExp?c.test(b):c instanceof Array?a.some(c,function(a){return e(a,b)}):false},f;for(f in d)if(e(d[f],b.getElementStyle(c,f)))return true;return false}};return b}();"undefined"==typeof ExtractContentJS&&(ExtractContentJS={});
(function(a){var b=a.Lib.Util,c=a.Lib.A,d=a.Lib.DOM,e=b.inherit(function(a,c,b,e){var f=b||{},g=e||1048576;return{node:a,depth:c||0,inside:f,statistics:function(){var c=(d.text(a)||"").replace(/\s+/g," "),b=c.length;return{text:c.substr(0,g),noLinkText:f.link||f.form?"":c,listTextLength:f.list?b:0,noListTextLength:f.list?0:b,linkCount:f.link?1:0,listCount:f.li?1:0,linkListCount:f.li&&f.link?1:0}}}},{commonAncestor:function(){var a=c.map(arguments,function(a){return a.node});return a.length<2?a[0]:
c.reduce(a,function(a,c){return d.commonAncestor(a,c)})},mergeStatistics:function(a,c){var b={},d;for(d in a)b[d]=a[d]+c[d];return b}}),f=function(a){var a=c.filter(a,function(a){a=d.text(a.node)||"";a=a.replace(/\s+/g,"");return a.length!=0}),b={score:0,leaves:a,commonAncestor:function(){return e.commonAncestor.apply(null,b.leaves)}};return b},g=function(a){var b={_content:a,asLeaves:function(){return b._content},asNode:function(){if(b._node)return b._node;b._node=e.commonAncestor.apply(null,b._content);
return b._node},asTextFragment:function(){if(b._textFragment)return b._textFragment;if(b._content.length<1)return"";b._textFragment=c.reduce(b._content,function(a,c){var b=d.text(c.node),b=b.replace(/^\s+/g,"").replace(/\s+$/g,""),b=b.replace(/\s+/g," ");return a+b},"");return b._textFragment},asText:function(){if(b._text)return b._text;var a=b.asNode();b._text=a?d.text(a):"";return b._text},toString:function(){return b.asTextFragment()}};return b};a.LayeredExtractor=function(b,c){var d={handler:b||
[],filter:c||{},factory:{getHandler:function(b){return typeof a.LayeredExtractor.Handler!="undefined"?new a.LayeredExtractor.Handler[b]:null}},addHandler:function(a){typeof a!="undefined"&&d.handler.push(a);return d},filterFor:function(){},extract:function(a){for(var b=a.location.href,c={title:a.title,url:a.location.href},e=d.handler.length,f=0;f<e;f++){var i=d.handler[f].extract(a,b,c);if(i){var h=d.filterFor(b);h&&(i=h.filter(i));i=new g(i);if(i.toString().length){c.content=i;c.isSuccess=true;c.engine=
c.engine||d.handler[f];break}}}return c}};return d};a.LayeredExtractor.Handler={};a.LayeredExtractor.Handler.Heuristics=function(a,g){var j={name:"Heuristics",content:[],opt:b.inherit(a,{threshold:60,minLength:30,factor:{decay:0.75,noBody:0.72,continuous:1.16},punctuationWeight:10,minNoLink:8,noListRatio:0.2,limit:{leaves:800,recursion:20,text:1048576},debug:false}),pat:b.inherit(g,{sep:["div","center","td","h1","h2"],waste:[/Copyright|All\s*Rights?\s*Reserved?/i],affiliate:[/amazon[a-z0-9\.\/\-\?&]+-22/i],
list:["ul","dl","ol"],li:["li","dd"],a:["a"],form:["form"],noContent:["frameset"],ignore:["iframe","img","script","style","select","noscript",["div",{id:[/more/,/menu/,/side/,/navi/],className:[/more/,/menu/,/side/,/navi/]}]],ignoreStyle:{display:"none",visibility:"hidden"},punctuations:/[\u3002\u3001\uFF0E\uFF0C\uFF01\uFF1F]|\.[^A-Za-z0-9]|,[^0-9]|!|\?/})},k=b.inherit(function(a){var g=new f(a);g.eliminateLinks=function(){var a=c.map(g.leaves,function(a){return a.statistics()});if(!a.length)return"";
var a=a.length==1?a[0]:c.reduce(a,function(a,b){return e.mergeStatistics(a,b)}),b=a.noLinkText.length,d=a.listTextLength;if(b<j.opt.minNoLink*a.linkCount)return"";var f=a.linkListCount/(a.listCount||1);return b<j.opt.noListRatio*f*f*d?"":a.noLinkText};g.noBodyRate=function(){var a=0;g.leaves.length>0&&(a=a+c.reduce(g.leaves,function(a,b){return a+d.countMatchTagAttr(b.node,"a","href",j.pat.affiliate)},0));return a=a/2+c.reduce(j.pat.waste,function(a,c){return a+b.countMatch(g._nolink,c)},0)};g.calcScore=
function(a,c){g._nolink=g.eliminateLinks();if(g._nolink.length<j.opt.minLength)return 0;var d=b.countMatch(g._nolink,j.pat.punctuations),d=d*j.opt.punctuationWeight,d=d+g._nolink.length,d=d*a,e=g.noBodyRate(),d=d*Math.pow(j.opt.factor.noBody,e);g._c=g.score=d;g._c1=d*c;return d};g.isAccepted=function(){return g._c>j.opt.threshold};g.isContinuous=function(){return g._c1>j.opt.threshold};g.merge=function(a){g.score=g.score+a._c1;g.depth=Math.min(g.depth,a.depth);c.push(g.leaves,a.leaves);return g};
return g},{split:function(a){var b=[],c=[],f=0,g=j.opt.limit.text,i=function(a){if(a&&c.length){b.push(new k(c));c=[]}},h=function(a,k,l){if(f>=j.opt.limit.leaves||k>=j.opt.limit.recursion||a.nodeName=="#comment"||d.matchTag(a,j.pat.ignore)||d.matchStyle(a,j.pat.ignoreStyle))return b;for(var u=a.childNodes,y=j.pat.sep,v=u.length,l={form:l.form||d.matchTag(a,j.pat.form),link:l.link||d.matchTag(a,j.pat.a),list:l.list||d.matchTag(a,j.pat.list),li:l.li||d.matchTag(a,j.pat.li)},t=0;t<v;t++){var w=u[t],
x=d.matchTag(w,y);i(x);h(w,k+1,l);i(x)}if(!v){f++;c.push(new e(a,k,l,g))}return b};h(a,0,{});i(true);return b}});j.extract=function(a){if(c.some(j.pat.noContent,function(b){return a.getElementsByTagName(b).length!=0}))return j;for(var b=1,d=1,e=[],f=k.split(a.body),g,i=f.length,h=0;h<i;h++){var q=f[h];g&&(d=d/j.opt.factor.continuous);if(q.calcScore(b,d)){b=b*j.opt.factor.decay;if(q.isAccepted()){if(q.isContinuous()&&g)g.merge(q);else{g=q;e.push(q)}d=j.opt.factor.continuous}else g||(b=1)}}j.blocks=
e.sort(function(a,b){return b.score-a.score});if(b=c.first(j.blocks))j.content=b.leaves;return j.content};return j};a.LayeredExtractor.Handler.GoogleAdSection=function(a){var d={name:"GoogleAdSection",content:[],state:[],opt:b.inherit(a,{limit:{leaves:800,recursion:20},debug:false})},g=/google_ad_section_start\(weight=ignore\)/i,k=/google_ad_section_start/i,l=/google_ad_section_end/i;d.inSection=function(){return c.last(d.state)==2};d.ignore=function(){d.state.push(1)};d.section=function(){d.state.push(2)};
d.end=function(){d.state.length&&d.state.pop()};d.parse=function(a,b){var c=b||0;if(a.nodeName=="#comment")g.test(a.nodeValue)?d.ignore():k.test(a.nodeValue)?d.section():l.test(a.nodeValue)&&d.end();else if(!(d.content.length>=d.opt.limit.leaves)&&!(c>=d.opt.limit.recursion)){for(var f=a.childNodes,h=f.length,s=0;s<h;s++)d.parse(f[s],c+1);!h&&d.inSection()&&d.content.push(new e(a,c))}};d.extract=function(a){d.parse(a);d.blocks=[new f(d.content)];return d.content};return d}})(ExtractContentJS);
Downsha.RequestMessage=function(a,b){this.initialize(a,b)};Downsha.RequestMessage.fromObject=function(a){var b=new Downsha.RequestMessage;if(typeof a=="object"&&a!=null){if(typeof a.code!="undefined")b.code=a.code;if(typeof a.message!="undefined")b.message=a.message}return b};Downsha.RequestMessage.prototype._code=0;Downsha.RequestMessage.prototype._message=null;Downsha.RequestMessage.prototype._callback=null;
Downsha.RequestMessage.prototype.initialize=function(a,b){this.__defineGetter__("code",this.getCode);this.__defineSetter__("code",this.setCode);this.__defineGetter__("message",this.getMessage);this.__defineSetter__("message",this.setMessage);this.__defineGetter__("callback",this.getCallback);this.__defineSetter__("callback",this.setCallback);this.code=a;this.message=b};Downsha.RequestMessage.prototype.getCode=function(){return this._code};
Downsha.RequestMessage.prototype.setCode=function(a){this._code=parseInt(a);if(isNaN(this._code))this._code=0};Downsha.RequestMessage.prototype.getMessage=function(){return this._message};Downsha.RequestMessage.prototype.setMessage=function(a){this._message=a};Downsha.RequestMessage.prototype.getCallback=function(){return this._callback};Downsha.RequestMessage.prototype.setCallback=function(a){if(typeof a=="function"||a==null)this._callback=a};
Downsha.RequestMessage.prototype.send=function(){chrome.extension.sendRequest({code:this.code,message:this.message})};Downsha.RequestMessage.prototype.isEmpty=function(){return this.code?false:true};
(function(){var a=null,b=false;Downsha.SelectionFinder=function(c){this.document=this.initDocument=c;a=Downsha.Logger.getInstance();a.level==Downsha.Logger.LOG_LEVEL_DEBUG&&(b=true)};Downsha.SelectionFinder.prototype.initDocument=null;Downsha.SelectionFinder.prototype.document=null;Downsha.SelectionFinder.prototype.selection=null;Downsha.SelectionFinder.prototype.reset=function(){this.document=this.initDocument;this.selection=null};Downsha.SelectionFinder.prototype.hasSelection=function(){var a=this.getRange();
return a&&(a.startContainer!=a.endContainer||a.startContainer==a.endContainer&&a.startOffset!=a.endOffset)?true:false};Downsha.SelectionFinder.prototype.find=function(a){a=this._findSelectionInDocument(this.document,a);this.document=a.document;this.selection=a.selection};Downsha.SelectionFinder.prototype.getRange=function(){if(!this.selection||this.selection.rangeCount==0)return null;if(typeof this.selection.getRangeAt=="function")return this.selection.getRangeAt(0);var a=this.document.createRange();
a.setStart(this.selection.anchorNode,this.selection.anchorOffset);a.setEnd(this.selection.focusNode,this.selection.focusOffset);return a};Downsha.SelectionFinder.prototype.getCommonAncestorContainer=function(){var a=this.getRange();if(a&&a.commonAncestorContainer){for(a=a.commonAncestorContainer;a&&a.nodeType!=Node.ELEMENT_NODE;)a=a.parentElement;return a}return null};Downsha.SelectionFinder.prototype._findSelectionInDocument=function(c,d){var e=null;typeof c.getSelection=="function"?e=c.getSelection():
c.selection&&typeof c.selection.createRange=="function"&&(e=c.selection.createRange());if(e&&e.rangeCount==0&&d){var f=Downsha.Utils.findDocuments(c);if(f.length>0){b&&a.debug("find selection range empty, trying frames, count: "+f.length);for(var g=0;g<f.length;g++)if(f[g]){b&&a.debug("trying nested doc: "+f[g]);var h=this._findSelectionInDocument(f[g],d);if(h.selection.rangeCount>0)return h}}}return{document:c,selection:e}}})();
Downsha.ClipStyle=function(a,b){this.__defineGetter__("styleFilter",this.getFilter);this.__defineSetter__("styleFilter",this.setFilter);this.initialize(a,b)};Downsha.ClipStyle.stylePrefix=function(a){if(typeof a=="string"){var b=0;if((b=a.indexOf("-"))>0)return a.substring(0,b)}return a};
Downsha.ClipStyle.findFontFaceRules=function(a){for(var a=(a||document).styleSheets,b=[],c=0;c<a.length;c++){var d=a[c];if(d.cssRules)for(var e=0;e<d.cssRules.length;e++){var f=d.cssRules[e];f instanceof CSSFontFaceRule&&b.push(f)}}return b};Downsha.ClipStyle.PERIMETERS=["top","right","bottom","left"];Downsha.ClipStyle.PERIMETER_PROPS={margin:null,padding:null};
Downsha.ClipStyle.PERIMETER_EXTRA_PROPS={border:["width","style","color"],"border-top":["width","style","color"],"border-right":["width","style","color"],"border-bottom":["width","style","color"],"border-left":["width","style","color"],outline:["width","style","color"]};Downsha.ClipStyle.prototype.length=0;Downsha.ClipStyle.prototype._filter=null;
Downsha.ClipStyle.prototype.initialize=function(a,b){this.styleFilter=b;if(a instanceof CSSRuleList||a instanceof Array){if(a.length>0)for(var c=0;c<a.length;c++)this.addStyle(a[c].style)}else a instanceof CSSStyleRule?this.addStyle(a.style):a instanceof CSSStyleDeclaration?this.addStyle(a):typeof a=="object"&&a!=null&&this.addStyle(a)};
Downsha.ClipStyle.prototype._addPerimeterStyle=function(a,b){var c=b.replace(/\s+/," ").split(" ");c.length==1?c=c.concat(c,c,c):c.length==2?c=c.concat(c[0],c[1]):c.length==3?c=c.concat(c[1]):c.length==0&&(c=["auto","auto","auto","auto"]);for(var d=0;d<Downsha.ClipStyle.PERIMETERS.length;d++)this._addSimpleStyle(a+"-"+Downsha.ClipStyle.PERIMETERS[d],c[d])};
Downsha.ClipStyle.prototype._addPerimeterExtraStyle=function(a,b){var c=Downsha.ClipStyle.PERIMETER_EXTRA_PROPS[a];if(c instanceof Array)for(var d=b.replace(/\s+/g," ").split(" "),e=RegExp(Downsha.ClipStyle.PERIMETERS.join("|"),"i"),e=a.match(e)?true:false,f=0;f<Downsha.ClipStyle.PERIMETERS.length;f++){for(var g=0;g<c.length;g++){var h=a+(e?"":"-"+Downsha.ClipStyle.PERIMETERS[f])+"-"+c[g];d[g]&&this._addSimpleStyle(h,d[g])}if(e)break}};
Downsha.ClipStyle.prototype._addSimpleStyle=function(a,b){typeof this[a]=="undefined"&&this.length++;this[a]=b};
Downsha.ClipStyle.prototype.addStyle=function(a){if(a instanceof CSSStyleDeclaration&&a.length>0)for(var b=0;b<a.length;b++){var c=a[b];if(!this.styleFilter||this.styleFilter(c,a.getPropertyValue(c))){var d=a.getPropertyValue(c);typeof Downsha.ClipStyle.PERIMETER_PROPS[c]!="undefined"?this._addPerimeterStyle(c,d):typeof Downsha.ClipStyle.PERIMETER_EXTRA_PROPS[c]!="undefined"?this._addPerimeterExtraStyle(c,d):this._addSimpleStyle(c,d)}}else if(a instanceof Downsha.ClipStyle)for(c in a){if(typeof this.constructor.prototype[c]==
"undefined"&&(!this.styleFilter||this.styleFilter(c,a[c]))){d=a[c];typeof Downsha.ClipStyle.PERIMETER_PROPS[c]!="undefined"?this._addPerimeterStyle(c,d):typeof Downsha.ClipStyle.PERIMETER_EXTRA_PROPS[c]!="undefined"?this._addPerimeterExtraStyle(c,d):this._addSimpleStyle(c,d)}}else if(typeof a=="object"&&a!=null)for(c in a)if((!this.styleFilter||this.styleFilter(c,a[c]))&&typeof a[c]!="function"&&typeof this.constructor.prototype[c]=="undefined"){d=a[c];typeof Downsha.ClipStyle.PERIMETER_PROPS[c]!=
"undefined"?this._addPerimeterStyle(c,d):typeof Downsha.ClipStyle.PERIMETER_EXTRA_PROPS[c]!="undefined"?this._addPerimeterExtraStyle(c,d):this._addSimpleStyle(c,d)}};
Downsha.ClipStyle.prototype.removeStyle=function(a,b){function c(a,c){if(typeof d[a]!="undefined"&&typeof d.constructor.prototype[a]=="undefined"&&(typeof b=="function"||d[a]==c))(typeof b!="function"||typeof b=="function"&&b(a,d[a],c))&&delete d[a]&&d.length--}var d=this;if(a instanceof CSSStyleDeclaration&&a.length>0)for(var e=0;e<a.length;e++){var f=a[e];c(f,a.getPropertyValue(f))}else if(a instanceof Downsha.ClipStyle&&a.length>0)for(f in a)c(f,a[f]);else if(a instanceof Array)for(e=0;e<a.length;e++)c(a[e],
this[a[e]]);else typeof a=="string"&&c(a,this[a])};Downsha.ClipStyle.prototype.removeStyleIgnoreValue=function(a){this.removeStyle(a,function(){return true})};Downsha.ClipStyle.styleInArray=function(a,b){if(typeof a!="string"||!(b instanceof Array))return false;for(var c=-1,d=a.toLowerCase(),e=(c=d.indexOf("-"))>0?d.substring(0,c):d,c=0;c<b.length;c++)if(b[c]==d||b[c]==e)return true;return false};
Downsha.ClipStyle.prototype.deriveStyle=function(a,b,c){this.removeStyle(a,function(a,e,f){return c instanceof Array&&Downsha.ClipStyle.styleInArray(a,c)?false:typeof b[a]!="undefined"&&e==f})};Downsha.ClipStyle.prototype.setFilter=function(a){if(typeof a=="function")this._filter=a;else if(a==null)this._filter=null};Downsha.ClipStyle.prototype.getFilter=function(){return this._filter};
Downsha.ClipStyle.prototype.mergeStyle=function(a,b){if(a instanceof Downsha.ClipStyle&&a.length>0){var c=true,d;for(d in a)if(!(typeof this.constructor.prototype[d]!="undefined"||typeof this.__lookupSetter__(d)!="undefined"))if((c=typeof this[d]=="undefined")||b){this[d]=a[d];c&&this.length++}}};Downsha.ClipStyle.prototype.clone=function(){var a=new Downsha.ClipStyle,b;for(b in this)typeof this.constructor.prototype[b]=="undefined"&&(a[b]=this[b]);a.length=this.length;return a};
Downsha.ClipStyle.prototype.toString_background=function(a){var b="";typeof this["background-color"]!="undefined"&&this["background-color"]!="rgba(0, 0, 0, 0)"&&(b=b+("background: "+this["background-color"]));if(typeof this["background-image"]!="undefined"&&this["background-image"]!="none"){b=b+(" "+this["background-image"]);typeof this["background-position"]!="undefined"&&(b=b+(" "+this["background-position"]));typeof this["background-repeat"]!="undefined"&&(b=b+(" "+this["background-repeat"]))}if(a){a["background-color"]=
null;a["background-image"]=null;a["background-position"]=null;a["background-repeat"]=null}b.length==0?b=b+"background:none;":b.length>0&&b.charAt(b.length-1)!=";"&&(b=b+";");return b};Downsha.ClipStyle.prototype.toString_outline=function(a){var b=this._toPerimeterExtraString("outline");if(a){a["outline-style"]=null;a["outline-width"]=null;a["outline-color"]=null}b.length>0&&b.charAt(b.length-1)!=";"?b=b+";":b.length==0&&(b="outline:none;");return b};
Downsha.ClipStyle.prototype.toString_margin=function(a){var b=this._toPerimeterString("margin");if(a){a["margin-top"]=null;a["margin-right"]=null;a["margin-bottom"]=null;a["margin-left"]=null}b.length>0&&b.charAt(b.length-1)!=";"?b=b+";":b.length==0&&(b="margin:none;");return b};
Downsha.ClipStyle.prototype.toString_padding=function(a){var b=this._toPerimeterString("padding");if(a){a["padding-top"]=null;a["padding-right"]=null;a["padding-bottom"]=null;a["padding-left"]=null}b.length>0&&b.charAt(b.length-1)!=";"?b=b+";":b.length==0&&(b="padding:none;");return b};
Downsha.ClipStyle.prototype.toString_border=function(a){var b=this._toPerimeterExtraString("border");if(a){a["border-top-width"]=null;a["border-top-style"]=null;a["border-top-color"]=null;a["border-right-width"]=null;a["border-right-style"]=null;a["border-right-color"]=null;a["border-bottom-width"]=null;a["border-bottom-style"]=null;a["border-bottom-color"]=null;a["border-left-width"]=null;a["border-left-style"]=null;a["border-left-color"]=null}b.length>0&&b.charAt(b.length-1)!=";"&&(b=b+";");if(b.length==
0||b.indexOf("none")>=0)b="border:none;";return b};
Downsha.ClipStyle.prototype.toString=function(a){var b="",c={};if(a){b=b+this.toString_background(c);b=b+this.toString_border(c);b=b+this.toString_margin(c);b=b+this.toString_outline(c);b=b+this.toString_padding(c)}else{if(this["background-image"]){b=b+("background-image:"+this["background-image"]+";");c["background-image"]=true}b=b+("background-repeat:"+(this["background-repeat-x"]?this["background-repeat-x"]:"initial")+" "+(this["background-repeat-y"]?this["background-repeat-y"]:"initial")+";");
c["background-repeat-x"]=true;c["background-repeat-y"]=true;c["background-repeat"]=true}if(this.length>0)for(var d in this)typeof this[d]!="string"||typeof this.constructor.prototype[d]!="undefined"||this[d].length==0||typeof c[d]!="undefined"||(b=b+(d+":"+this[d]+";"));return b};
Downsha.ClipStyle.prototype._toPerimeterString=function(a){for(var b=[],c=true,d=false,e="",f=0;f<Downsha.ClipStyle.PERIMETERS.length;f++){b[f]=this[a+"-"+Downsha.ClipStyle.PERIMETERS[f]];b[f]?e=e+(a+"-"+Downsha.ClipStyle.PERIMETERS[f]+":"+b[f]+";"):d=true;f>0&&c&&b[f]!=b[f-1]&&(c=false)}if(d)return e;c?b=[b[0]]:b[0]==b[2]&&b[1]==b[3]&&(b=[b[0],b[1]]);return a+":"+b.join(" ")+";"};
Downsha.ClipStyle.prototype._toPerimeterExtraString=function(a){for(var b=[],c=true,d="",e=0;e<Downsha.ClipStyle.PERIMETERS.length;e++){var f=a+"-"+Downsha.ClipStyle.PERIMETERS[e],g=Downsha.ClipStyle.PERIMETER_EXTRA_PROPS[f]||Downsha.ClipStyle.PERIMETER_EXTRA_PROPS[a];if(g instanceof Array){for(var h="",i="",j=false,k=0;k<g.length;k++){var l=f+"-"+g[k];if(this[l]){h=h+(this[l]+(k==g.length-1?"":" "));i=i+(l+":"+this[l]+";")}else{j=true;c=false}}if(j)d=d+i;else{b[e]=h;d=d+(f+":"+h+";")}}if(e>0&&c&&
(!b[e]||b[e]!=b[e-1]))c=false}return c?a+":"+b[0]+";":d};Downsha.ClipStyle.prototype.toJSON=function(){var a={};if(this.length>0)for(var b in this)typeof this[b]!="string"||typeof this.constructor.prototype[b]!="undefined"||this[b].length==0||(a[b]=this[b]);return a};Downsha.ClipStylingStrategy=function(a){this.initialize(a)};Downsha.ClipStylingStrategy.DEFAULT_FILTER=function(a,b){return b&&a!="orphans"&&a!="widows"&&a!="speak"&&a.indexOf("page-break")!=0&&a.indexOf("pointer-events")!=0};
Downsha.ClipStylingStrategy.prototype.initialize=function(a){this.window=a};Downsha.ClipStylingStrategy.prototype.styleForNode=function(){return null};Downsha.ClipStylingStrategy.prototype.getNodeView=function(a){a=a.ownerDocument;return a.defaultView?a.defaultView:this.window};
Downsha.ClipStylingStrategy.prototype.getNodeStyle=function(a,b,c){c=typeof c=="function"?c:Downsha.ClipStylingStrategy.DEFAULT_FILTER;if(a&&typeof a.nodeType=="number"&&a.nodeType==1){var d=this.getNodeView(a),e=typeof d.getMatchedCSSRules=="function"?true:false;if(b)return style=new Downsha.ClipStyle(d.getComputedStyle(a,""),c);if(e)return style=new Downsha.ClipStyle(d.getMatchedCSSRules(a,""),c)}a=new Downsha.ClipStyle;a.setFilter(c);return a};
Downsha.ClipStylingStrategy.prototype.getFontFaceRules=function(){return Downsha.ClipStyle.findFontFaceRules()};Downsha.ClipStylingStrategy.prototype.cleanUp=function(){return true};Downsha.ClipStylingStrategy.prototype.styleForFloatClearingNode=function(){return null};Downsha.ClipTextStylingStrategy=function(a){this.initialize(a)};Downsha.inherit(Downsha.ClipTextStylingStrategy,Downsha.ClipStylingStrategy);
Downsha.ClipTextStylingStrategy.FORMAT_NODE_NAMES={b:null,big:null,em:null,i:null,small:null,strong:null,sub:null,sup:null,ins:null,del:null,s:null,strike:null,u:null,code:null,kbd:null,samp:null,tt:null,"var":null,pre:null,listing:null,plaintext:null,xmp:null,abbr:null,acronym:null,address:null,bdo:null,blockquote:null,q:null,cite:null,dfn:null};Downsha.ClipTextStylingStrategy.STYLE_ATTRS={font:null,text:null,color:null};Downsha.ClipTextStylingStrategy.COLOR_THRESH=50;
Downsha.ClipTextStylingStrategy.prototype.isFormatNode=function(a){return a&&a.nodeType==1&&typeof Downsha.ClipTextStylingStrategy.FORMAT_NODE_NAMES[a.nodeName.toLowerCase()]!="undefined"};Downsha.ClipTextStylingStrategy.prototype.hasTextNodes=function(a){if(a&&a.nodeType==1&&a.childNodes.length>0)for(var b=0;b<a.childNodes.length;b++)if(a.childNodes[b].nodeType==3)return true;return false};
Downsha.ClipTextStylingStrategy.prototype.styleFilter=function(a){a=Downsha.ClipStyle.stylePrefix(a.toLowerCase());if(typeof Downsha.ClipTextStylingStrategy.STYLE_ATTRS[a]!="undefined")return true};
Downsha.ClipTextStylingStrategy.prototype.styleForNode=function(a){var b=null;if(this.isFormatNode(a)||this.hasTextNodes(a))b=this.getNodeStyle(a,true,this.styleFilter);if(b&&b.color){var c=b.color.replace(/[^0-9,\s]+/g,"").replace(/[,\s]+/g," ").split(/\s+/),d=parseInt(c[0]),d=isNaN(d)?0:d,e=parseInt(c[1]),e=isNaN(e)?0:d,f=parseInt(c[2]),f=isNaN(f)?0:f;if(d+e+f>(255-Downsha.ClipTextStylingStrategy.COLOR_THRESH)*3){d=Math.max(0,d-Downsha.ClipTextStylingStrategy.COLOR_THRESH);e=Math.max(0,e-Downsha.ClipTextStylingStrategy.COLOR_THRESH);
f=Math.max(0,f-Downsha.ClipTextStylingStrategy.COLOR_THRESH)}b.color=c.length==4?"rgba("+[d,e,f,1].join(", ")+")":"rgb("+[d,e,f].join(", ")+")"}if(b&&!b.direction)(a=this.getNodeStyle(a,true))&&a.direction&&a.direction!="ltr"&&b._addSimpleStyle("direction",a.direction);return b};
(function(){var a=null;Downsha.ClipFullStylingStrategy=function(b){a=Downsha.Logger.getInstance();this.initialize(b)};Downsha.inherit(Downsha.ClipFullStylingStrategy,Downsha.ClipStylingStrategy);Downsha.ClipFullStylingStrategy.SKIP_UNDEFINED_PROPS={widows:null,orphans:null,"pointer-events":null,speak:null};Downsha.ClipFullStylingStrategy.SKIP_NONINHERENT_AUTO_PROPS={left:"auto",right:"auto","float":"auto",clear:"auto","image-rendering":"auto","z-index":"auto","color-rendering":"auto","shapre-rendering":"auto",
"page-break-before":"auto","page-break-after":"auto","page-break-inside":"auto"};Downsha.ClipFullStylingStrategy.LIST_NODES={UL:null,OL:null,LI:null};Downsha.ClipFullStylingStrategy.NODE_PROPS={BR:["clear","padding","margin","line-height","border","white-space"]};Downsha.ClipFullStylingStrategy.TEXT_NODES={A:null,B:null,BIG:null,EM:null,I:null,SMALL:null,STRONG:null,SUB:null,SUP:null,INS:null,DEL:null,S:null,STRIKE:null,U:null,CODE:null,KBD:null,SAMP:null,TT:null,VAR:null,PRE:null,LISTING:null,PLAINTEXT:null,
XMP:null,ABBR:null,ACRONYM:null,ADDRESS:null,BDO:null,BLOCKQUOTE:null,Q:null,CITE:null,DFN:null};Downsha.ClipFullStylingStrategy.prototype.styleForNode=function(b,c,d){var e=this.getNodeStyle(b,false),f=e.height,g=this.getNodeStyle(b,true),h=b.style,i=b==c?true:false;if(i){g["font-size"]&&e._addSimpleStyle("font-size",g["font-size"]);g["font-family"]&&e._addSimpleStyle("font-family",g["font-family"]);e._addSimpleStyle("margin","0px");e.position?e.position="relative":e._addSimpleStyle("position","relative");
if(!d){var j=this._inhBackgroundForNode(b,true);j.length>0&&e.mergeStyle(j,false);var k=this._inhFontForNode(b,true);k.length>0&&e.mergeStyle(k,false);if(b.nodeName!="HTML"&&b.nodeName!="BODY"&&j["background-image"]){a.debug("Setting fixed width because it's not a top-level tag and has background-image");g.width&&g.width!="0px"&&e._addSimpleStyle("width",g.width);f&&g.height&&g.height!="0px"&&e._addSimpleStyle("height",g.height)}e["float"]&&e.removeStyle("float")}}if(!d&&b.childElementCount!=b.childNodes.length){j=
false;for(k=0;k<b.childNodes.length;k++)if(b.childNodes[k].nodeType==Node.TEXT_NODE){j=true;break}if(j&&g["font-size"]){a.debug("Adding font-size to text node without font-size spec");e._addSimpleStyle("font-size",g["font-size"])}}if(b.nodeName=="CANVAS"&&typeof b.toDataURL=="function")e._addSimpleStyle("background-image","url("+b.toDataURL()+")");else if(b.nodeName=="OBJECT"||b.nodeName=="EMBED"){e._addSimpleStyle("width",g.width);e._addSimpleStyle("min-width",g.width);e._addSimpleStyle("max-width",
g.width);e._addSimpleStyle("height",g.height);e._addSimpleStyle("min-height",g.height);e._addSimpleStyle("max-height",g.height);e._addSimpleStyle("display",g.display);e._addSimpleStyle("overflow",g.hidden)}if(!d&&(i||b.parentElement==c)&&e.position=="absolute"){b=b.getBoundingClientRect();i=parseInt(g["margin-left"]);d=parseInt(g["margin-top"]);i=b.left-(isNaN(i)?0:i);b=b.top-(isNaN(d)?0:d);if(typeof c._downsha_absolute_xOffset=="number"&&typeof c._downsha_absolute_yOffset=="number"){i=Math.max(0,
i-c._downsha_absolute_xOffset);b=Math.max(0,b-c._downsha_absolute_yOffset);e._addSimpleStyle("left",i+"px");e._addSimpleStyle("top",b+"px")}else{c._downsha_absolute_xOffset=i;c._downsha_absolute_yOffset=b;e._addSimpleStyle("top","0px");e._addSimpleStyle("left","0px")}e.removeStyle("right");e.removeStyle("bottom")}for(c=0;c<h.length;c++)e._addSimpleStyle(h[c],h.getPropertyValue(h[c]));f&&e.height&&g.height&&(e.height=g.height);!e.direction&&g.direction&&g.direction!="ltr"&&e._addSimpleStyle("direction",
g.direction);return e};Downsha.ClipFullStylingStrategy.prototype._hasTextOnlyChildren=function(a){if(a){if(a.childElementCount!=0)for(var c=a.childElementCount,d=0;d<c;d++)if(typeof this.constructor.TEXT_NODES[a.children[d]]=="undefined")return false;return true}return false};Downsha.ClipFullStylingStrategy.prototype._mergeBoundingRects=function(a,c){a.left=Math.min(a.left,c.left);a.right=Math.max(a.right,c.right);a.top=Math.min(a.top,c.top);a.bottom=Math.max(a.bottom,c.bottom);a.width=a.right-a.left;
a.height=a.bottom-a.top};Downsha.ClipFullStylingStrategy.prototype._inhBackgroundForNode=function(b,c){a.debug("ClipFullStylingStrategy._inhBackgroundForNode");for(var d=b.parentNode,e=[],f=[],g=["background-repeat-x","background-repeat-y","background-position-x","background-position-y","background-origin","background-size"],h=this.window.document.body.parentElement?this.window.document.body.parentElement:this.window.document.body;d;){f.push(d);e.push(this.getNodeStyle(d,true,function(a,b){return a==
"background-color"||a=="background-image"&&b!="none"||g.indexOf(a)>=0||a=="opacity"||a=="filter"?true:false}));if(!c||d==h)break;else d=d.parentElement}a.debug("Retracted "+e.length+" styles");for(var d=new Downsha.ClipStyle,i=h=0;i<e.length;i++){var j=e[i],k=f[i];a.dir(j);if(j["background-color"]&&j["background-color"]!="transparent"&&!j["background-color"].match(/rgba\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*,\s*0\s*\)/)&&!d["background-color"]){a.debug("Setting background-color: "+j["background-color"]);
h=i;d._addSimpleStyle("background-color",j["background-color"])}if(j["background-image"]&&!d["background-image"]&&(i==h||!d["background-color"])){a.debug("Adding background-image: "+j["background-image"]);d._addSimpleStyle("background-image",j["background-image"]);for(var l=0;l<g.length;l++){var m=g[l];if(j[m]&&m.indexOf("background-repeat")<0){a.debug("Adding "+m);d._addSimpleStyle(m,j[m])}}l=j["background-repeat-x"]&&j["background-repeat-x"]!="initial"?j["background-repeat-x"]:"no-repeat";m=j["background-repeat-y"]&&
j["background-repeat=y"]!="initial"?j["background-repeat-y"]:"no-repeat";d._addSimpleStyle("background-repeat-x",l);d._addSimpleStyle("background-repeat-y",l);d._addSimpleStyle("background-repeat",l+" "+m);if(k){a.debug("Dettermining background image offset");m=k.getBoundingClientRect();a.debug("bgNodeRect left: "+m.left+"; top: "+m.top);var n=b.getBoundingClientRect();a.debug("nodeRect left: "+n.left+"; top: "+n.top);l=n.top-m.top;n=n.left-m.left;a.debug("xDelta: "+n+"; yDelta: "+l);var o=this.getNodeView(k).getComputedStyle(k),
k=o.getPropertyValue("background-position-x"),p=o.getPropertyValue("background-position-y");a.debug("bg position: "+k+" "+p);var r=0,o=0,r=k.indexOf("%")>0?m.width*(parseInt(k)/100):parseInt(k),o=p.indexOf("%")>0?m.height*(parseInt(p)/100):parseInt(p);isNaN(r)&&(r=0);isNaN(o)&&(o=0);a.debug("origPosX: "+r+"; origPosY: "+o);m=0-n+r;l=0-l+o;a.debug("xOffset: "+m+"; yOffset: "+l);d._addSimpleStyle("background-position",m+"px "+l+"px")}}j.opacity&&!d.opacity&&!isNaN(parseFloat(j.opacity))&&(typeof d.opacity==
"undefined"||parseFloat(j.opacity)<parseFloat(d.opacity))&&d._addSimpleStyle("opacity",j.opacity);j.filter&&!d.filter&&(typeof d.filter=="undefined"||parseFloat(j.filter.replace(/[^0-9]+/g,""))<parseFloat(d.filter.replace(/[^0-9]+/g,"")))&&d._addSimpleStyle("filter",j.filter)}return d};Downsha.ClipFullStylingStrategy.prototype._inhFontForNode=function(b,c){for(var d=b.parentNode,e=[],f=[],g=["font-family","color","line-height"];d;){f.push(d);e.push(this.getNodeStyle(d,true,function(a){return g.indexOf(a)>=
0?true:false}));if(!c||d==this.window.document.body)break;else d=d.parentElement}d=new Downsha.ClipStyle;for(f=0;f<e.length;f++)for(var h=e[f],i=0;i<g.length;i++)if(!d[g[i]]&&h[g[i]]){a.debug("Adding "+g[i]+": "+h[g[i]]);d._addSimpleStyle(g[i],h[g[i]])}return d};Downsha.ClipFullStylingStrategy.prototype.cleanUp=function(){if(this._dirty)for(var a=this.window.document.getElementsByTagName("*"),c=0;c<a.length;c++)delete a[c][this.constructor.COMPUTED_STYLE_KEY];return true};Downsha.ClipFullStylingStrategy.prototype.styleForFloatClearingNode=
function(a){if(a){a=new Downsha.ClipStyle;a._addSimpleStyle("clear","both");a._addSimpleStyle("width","0px");a._addSimpleStyle("height","0px");return a}return null}})();
(function(){var a=null,b=false;Downsha.Clip=function(c,d,e,f){a=Downsha.Logger.getInstance();a.level==Downsha.Logger.LOG_LEVEL_DEBUG&&(b=true);this.__defineGetter__("fullPage",this.isFullPage);this.__defineGetter__("length",this.getLength);this.__defineGetter__("stylingStrategy",this.getStylingStrategy);this.__defineSetter__("stylingStrategy",this.setStylingStrategy);this.__defineGetter__("documentBase",this.getDocumentBase);this.__defineSetter__("documentBase",this.setDocumentBase);this.__defineGetter__("maxSize",
this.getMaxSize);this.__defineSetter__("maxSize",this.setMaxSize);this.__defineGetter__("sizeExceeded",this.isSizeExceeded);this.__defineSetter__("sizeExceeded",this.setSizeExceeded);this.__defineGetter__("url",this.getUrl);this.__defineSetter__("url",this.setUrl);this.initialize(c,d,e,f)};Downsha.Clip.NOKEEP_NODE_ATTRIBUTES={style:null,tabindex:null,"class":null,id:null,_downshaPreviewRect:null};Downsha.Clip.CONDITIONAL_NODES={EMBED:null,OBJECT:null};Downsha.Clip.NODE_NAME_TRANSLATIONS={HTML:"DIV",
BODY:"DIV",FORM:"DIV",LABEL:"SPAN",FIELDSET:"DIV",LEGEND:"SPAN",SECTION:"DIV",CANVAS:"DIV",CUFON:"DIV","*":"DIV"};Downsha.Clip.SUPPORTED_NODES={A:null,ABBR:null,ACRONYM:null,ADDRESS:null,AREA:null,B:null,BASE:null,BASEFONT:null,BDO:null,BIG:null,BLOCKQUOTE:null,BR:null,BUTTON:null,CAPTION:null,CENTER:null,CITE:null,CODE:null,COL:null,COLGROUP:null,DD:null,DEL:null,DFN:null,DIR:null,DIV:null,DL:null,DT:null,EM:null,EMBED:null,FIELDSET:null,FONT:null,FORM:null,FRAME:null,FRAMESET:null,H1:null,H2:null,
H3:null,H4:null,H5:null,H6:null,HEAD:null,HR:null,HTML:null,I:null,IFRAME:null,IMG:null,INPUT:null,INS:null,KBD:null,LABEL:null,LEGEND:null,LI:null,LINK:null,MAP:null,MENU:null,META:null,NOBR:null,NOFRAMES:null,NOSCRIPT:null,OBJECT:null,OL:null,OPTGROUP:null,OPTION:null,P:null,PARAM:null,PRE:null,Q:null,QUOTE:null,S:null,SAMP:null,SCRIPT:null,SELECT:null,SMALL:null,SPAN:null,STRIKE:null,STRONG:null,STYLE:null,SUB:null,SUP:null,TABLE:null,TBODY:null,TD:null,TEXTAREA:null,TFOOT:null,TH:null,THEAD:null,
TITLE:null,TR:null,TT:null,U:null,UL:null,VAR:null};Downsha.Clip.REJECT_NODES={SCRIPT:null,STYLE:null,INPUT:null,SELECT:null,OPTION:null,OPTGROUP:null,TEXTAREA:null,NOSCRIPT:null,HEAD:null,DOWNSHADIV:null,CUFONTEXT:null,NOEMBED:null};Downsha.Clip.NON_ANCESTOR_NODES={OL:null,UL:null,LI:null};Downsha.Clip.SELF_CLOSING_NODES={IMG:null,INPUT:null,BR:null};Downsha.Clip.HTMLEncode=function(a){for(var b="",e=0;e<a.length;e++)var f=a.charCodeAt(e),g=a[e],b=f>127?b+("&#"+f+";"):g==">"?b+"&gt;":g=="<"?b+"&lt;":
g=="&"?b+"&amp;":b+a[e];return b};Downsha.Clip.prototype.title=null;Downsha.Clip.prototype.location=null;Downsha.Clip.prototype.window=null;Downsha.Clip.prototype.selectionFinder=null;Downsha.Clip.prototype.deep=true;Downsha.Clip.prototype._stylingStrategy=null;Downsha.Clip.prototype._documentBase=null;Downsha.Clip.prototype._maxSize=0;Downsha.Clip.prototype._sizeExceeded=false;Downsha.Clip.prototype.notebookGuid=false;Downsha.Clip.prototype.tagNames=false;Downsha.Clip.prototype.comment=false;Downsha.Clip.prototype._includeFontFaceDescriptions=
false;Downsha.Clip.prototype.initialize=function(a,b,e,f){this.window=a?a:window;this.title=this.window.document.title;this.location=this.window.location;this.selectionFinder=new Downsha.SelectionFinder(this.window.document);this.range=null;if(b)this.stylingStrategy=b;this.maxSize=e;this.articleRules=f};Downsha.Clip.prototype.onsizeexceed=null;Downsha.Clip.prototype.isFullPage=function(){return!this.hasSelection()};Downsha.Clip.prototype.hasSelection=function(){if(this.selectionFinder.hasSelection())return true;
this.selectionFinder.find(this.deep);return this.selectionFinder.hasSelection()};Downsha.Clip.prototype.getSelection=function(){return this.hasSelection()?this.selectionFinder.selection:null};Downsha.Clip.prototype.getRange=function(){return this.hasSelection()?this.selectionFinder.getRange():null};Downsha.Clip.prototype.hasBody=function(){return this.window&&this.window.document&&this.window.document.body&&this.window.document.body.tagName.toLowerCase()=="body"};Downsha.Clip.prototype.hasContentToClip=
function(){return this.hasBody()||this.hasSelection()};Downsha.Clip.prototype.getDocumentBase=function(){if(this._documentBase==null){var a=this.window.document.getElementsByTagName("base");if(a.length>0)for(var b=0;b<a.length;b++){this.setDocumentBase(a[b].href);if(this._documentBase)break}if(!this._documentBase)this._documentBase=this.location.origin+this.location.pathname.replace(/[^\/]+$/,"")}return this._documentBase};Downsha.Clip.prototype.setDocumentBase=function(a){this._documentBase=typeof a==
"string"&&a.indexOf("http")==0?a:null};Downsha.Clip.prototype.getMaxSize=function(){return this._maxSize};Downsha.Clip.prototype.setMaxSize=function(a){this._maxSize=parseInt(a);if(isNaN(this._maxSize)||a<0)this._maxSize=0};Downsha.Clip.prototype.isSizeExceeded=function(){return this._sizeExceeded};Downsha.Clip.prototype.setSizeExceeded=function(a){this._sizeExceeded=a?true:false};Downsha.Clip.prototype.getUrl=function(){if(!this._url)this._url=this.location.href;return this._url};Downsha.Clip.prototype.setUrl=
function(a){if(typeof a=="string"||a==null)this._url=a};Downsha.Clip.prototype.clipBody=function(){if(!this.hasBody()){b&&a.debug("Document has no body...");return false}this.stylingStrategy&&this.stylingStrategy.cleanUp();var c=0,d=0;if(b){a.debug("Getting body text: "+this);c=(new Date).getTime()}this.content=this.serializeDOMNode(this.window.document.body,true);if(b){d=(new Date).getTime();a.debug("Clipped body in "+(d-c)+" milliseconds")}return typeof this.content!="string"?false:true};Downsha.Clip.prototype.clipElement=
function(c){if(c){this.stylingStrategy&&this.stylingStrategy.cleanUp();var d=0,e=0;if(b){a.debug("Getting element text: "+this);d=(new Date).getTime()}this.content=this.serializeDOMNode(c,true);if(b){e=(new Date).getTime();a.debug("Clipped element's content in "+(e-d)+" milliseconds")}if(typeof this.content=="string")return true}a.debug("Cannot clip because no valid element was specified");return false};Downsha.Clip.prototype.clipSelection=function(){if(!this.hasSelection()){b&&a.debug("Document has no selection...");
return false}this.stylingStrategy&&this.stylingStrategy.cleanUp();var c=0,d=0;if(this.range=this.getRange()){b&&(c=(new Date).getTime());for(var e=this.stylingStrategy&&this.range.commonAncestorContainer.nodeType==Node.TEXT_NODE&&this.range.commonAncestorContainer.parentNode?this.range.commonAncestorContainer.parentNode:this.range.commonAncestorContainer;typeof Downsha.Clip.NON_ANCESTOR_NODES[e.nodeName]!="undefined"&&e.parentNode;){if(e.nodeName=="BODY")break;e=e.parentNode}this.content=this.serializeDOMNode(e,
false);b&&(d=(new Date).getTime());this.range=null;b&&a.debug("Clipped selection in "+(d-c)+" milliseconds");return true}this.range=null;return false};Downsha.Clip.prototype.serializeDOMNode=function(b,d){var e="";if(this._includeFontFaceDescriptions&&this.stylingStrategy){var f=this.stylingStrategy.getFontFaceRules();if(f){for(var e=e+"<style>\n",g=0;g<f.length;g++)e=e+(f[g].cssText+"\n");e=e+"</style>\n"}}f=b;try{for(;f;){if(this.maxSize>0&&e.length>this.maxSize){a.debug("Length of serialized content exceeds "+
this.maxSize);this.sizeExceeded=true;if(typeof this.onsizeexceed=="function")this.onsizeexceed();break}var h=!this.range||this.range.intersectsNode(f)?true:false;if(h&&f.nodeType==Node.TEXT_NODE)this.range?this.range.startContainer==f&&this.range.startContainer==this.range.endContainer?e=e+this.constructor.HTMLEncode(f.nodeValue.substring(this.range.startOffset,this.range.endOffset)):this.range.startContainer==f?e=e+this.constructor.HTMLEncode(f.nodeValue.substring(this.range.startOffset)):this.range.endContainer==
f?e=e+this.constructor.HTMLEncode(f.nodeValue.substring(0,this.range.endOffset)):this.range.commonAncestorContainer!=f&&(e=e+this.constructor.HTMLEncode(f.nodeValue)):e=e+this.constructor.HTMLEncode(f.nodeValue);else if(h&&f.nodeType==Node.ELEMENT_NODE&&typeof Downsha.Clip.CONDITIONAL_NODES[f.nodeName]!="undefined"){if(this.isNodeVisible(f)){var i=null;this.stylingStrategy&&(i=this.stylingStrategy.styleForNode(f,b,d));var j=this.serializeConditionalElement(f,i);typeof j=="string"&&j&&(e=e+j)}}else if(h&&
f.nodeType==Node.ELEMENT_NODE&&typeof Downsha.Clip.REJECT_NODES[f.nodeName]=="undefined"&&this.isNodeVisible(f)){for(var k=f.attributes,g="",l=0;l<k.length;l++)if(k[l]&&k[l].name&&k[l].specified&&typeof Downsha.Clip.NOKEEP_NODE_ATTRIBUTES[k[l].name]=="undefined"&&k[l].name.substring(0,2).toLowerCase()!="on"&&!(k[l].name=="href"&&k[l].value.substring(0,11).toLowerCase()=="javascript:")){var m=k[l].value?k[l].value:"";if(k[l].name=="src"||k[l].name=="href"){typeof m=="string"&&m.length>0&&m.substring(0,
4).toLowerCase().indexOf("http")!=0&&m.substring(0,11).toLowerCase().indexOf("data:image/")!=0&&(m=Downsha.Utils.absoluteUrl(m,this.getDocumentBase()));m.substring(0,4).toLowerCase().indexOf("http")==0&&(m=Downsha.Utils.escapeURL(m))}else m=Downsha.Utils.escapeXML(m);g=m?g+(" "+k[l].name+'="'+m+'"'):g+(" "+k[l].name)}if(this.stylingStrategy){i=this.stylingStrategy.styleForNode(f,b,d);if(i instanceof Downsha.ClipStyle&&i.length>0){if(i["float"]&&i["float"]!="none"&&f.parentElement)f.parentElement._downsha_float_=
true;g=g+(' style="'+i.toString().replace(/\"/g,"")+'"')}else typeof i=="string"&&(g=g+(' style="'+i.replace(/\"/g,"")+'"'))}var n=Downsha.Clip.NODE_NAME_TRANSLATIONS[f.nodeName]||f.nodeName,n=typeof Downsha.Clip.SUPPORTED_NODES[n]!="undefined"?n:Downsha.Clip.NODE_NAME_TRANSLATIONS["*"],e=e+("<"+n+g);if(window.getComputedStyle(f,"").getPropertyValue("visibility")!="hidden"&&f.hasChildNodes()){e=e+">";f=f.childNodes[0];continue}else e=typeof Downsha.Clip.SELF_CLOSING_NODES[n]=="undefined"?e+("></"+
n+">"):e+"/>"}if(f.nextSibling)f=f.nextSibling;else if(f!=b){if(f.parentElement&&f.parentElement._downsha_float_){var o=this.getFloatClearingElementString(f.parentElement),e=e+o;delete f.parentElement._downsha_float_}for(;f.parentNode;){f=f.parentNode;f==b&&(e=e+"<div style='clear: both'></div>");n=Downsha.Clip.NODE_NAME_TRANSLATIONS[f.nodeName]||f.nodeName;n=typeof Downsha.Clip.SUPPORTED_NODES[n]!="undefined"?n:Downsha.Clip.NODE_NAME_TRANSLATIONS["*"];e=e+("</"+n+">");if(f==b)break;else if(f.nextSibling){f=
f.nextSibling;break}else if(f.parentElement&&f.parentElement._downsha_float_){o=this.getFloatClearingElementString(f.parentElement);e=e+o;delete f.parentElement._downsha_float_}}if(f==b)break;else if(f.nodeName=="#document"||f.nodeType==Node.DOCUMENT_NODE)break}else break}}catch(p){if(p instanceof DOMException&&p.code==DOMException.SECURITY_ERR)a.debug("Ignoring DOMException.SECURITY_ERR for node: "+Downsha.Utils.getNodeString(f));else{a.error("Error serializing node: "+Downsha.Utils.getNodeString(f));
throw p;}}return e};Downsha.Clip.prototype.getFloatClearingElementString=function(a){var b="";if(a&&this.stylingStrategy){var e=this.stylingStrategy.styleForFloatClearingNode(a);if(e&&e.length>0){b="div";a.nodeName=="UL"||a.nodeName=="OL"?b="li":a.nodeName=="DL"&&(b="dd");b="<"+b+' style="'+e.toString()+'"></'+b+">"}}return b};Downsha.Clip.prototype.isNodeVisible=function(a){var b=window.getComputedStyle(a),a=b.getPropertyValue("display"),e=b.getPropertyValue("visibility"),b=b.getPropertyValue("position");
return a!="none"&&!(e=="hidden"&&b=="absolute")?true:false};Downsha.Clip.prototype.serializeConditionalElement=function(a,b){var e="";if(a&&a.nodeType==Node.ELEMENT_NODE){var f=a.ownerDocument||document,g=null;if(g=this.articleRules){var h=null,i=null;if(g.d){var j=Downsha.Utils.querySelectors(g.d,f);if(j)h=j.textContent}if(g.t)for(j=0;j<g.t.length;j++){var k=g.t[j],l=f;k.b==="relative"&&(l=a);var m=Downsha.Utils.querySelectors(k.s,l);if(m){l="";if(k.d==="value")l=m.value;else if(k.d==="textContent")l=
m.textContent;else if(k.d==="innerHTML")l=m.innerHTML;else if(k.d){l=m.getAttribute(k.d);if(k.d==="src"||k.d==="href")l=decodeURIComponent(l)}if(l){if(k.p){m=RegExp(k.p,"i");(l=l.match(m))&&l[1]&&(i=l[1])}else i=l;if(i&&k.m&&typeof k.r=="string"){m=RegExp(k.m,"i");i=i.replace(m,k.r)}if(i)break}}}if(h||i){e=e+'<div style="display:none;">';h&&(e=e+("<span>"+h+"</span>"));i&&(e=e+('<img src="'+i+'" />'));e=e+"</div>"}}}return e=e+this.serializePluginElement(a,b)};Downsha.Clip.prototype.serializePluginElement=
function(a,b){for(var e=function(a){for(var b="",a=a.attributes,c=0;c<a.length;c++)if(a[c]&&a[c].name&&a[c].specified&&typeof Downsha.Clip.NOKEEP_NODE_ATTRIBUTES[a[c].name]=="undefined"&&a[c].name.substring(0,2).toLowerCase()!="on"&&!(a[c].name=="href"&&a[c].value.substring(0,11).toLowerCase()=="javascript:")){b=b+(" "+a[c].name);a[c].value&&(b=b+('="'+a[c].value.replace('"',"&quot;")+'"'))}return b},f=b instanceof Downsha.ClipStyle?'style="'+b.toString()+'"':"",f="<"+a.nodeName+e(a)+" "+f+">",g=
a.children,h=0;h<g.length;h++)f=f+("<"+g[h].nodeName+e(g[h])+" />");return f=f+("</"+a.nodeName+">")};Downsha.Clip.prototype.setStylingStrategy=function(a){if(typeof a=="function"&&Downsha.inherits(a,Downsha.ClipStylingStrategy))this._stylingStrategy=new a(this.window);else if(a instanceof Downsha.ClipStylingStrategy)this._stylingStrategy=a;else if(a==null)this._stylingStrategy=null};Downsha.Clip.prototype.getStylingStrategy=function(){return this._stylingStrategy};Downsha.Clip.prototype.toString=
function(){return"Downsha.Clip["+this.location+"] ("+(this.content?this.content.length:0)+") "+this.title};Downsha.Clip.prototype.getLength=function(){var a=0,b=this.toDataObject(),e;for(e in b)a=a+((""+b[e]).length+e.length+2);return a-1};Downsha.Clip.prototype.toDataObject=function(){return{content:this.content,title:this.title,url:this.url,fullPage:this.fullPage,sizeExceeded:this.sizeExceeded,notebookGuid:this.notebookGuid,tagNames:this.tagNames,comment:this.comment}};Downsha.Clip.prototype.toLOG=
function(){return{title:this.title,url:this.url,fullPage:this.fullPage,sizeExceeded:this.sizeExceeded,contentLength:this.content.length}}})();
(function(){Downsha.AbstractStyleScript=function(){Downsha.Logger.getInstance();this.initialize()};Downsha.AbstractStyleScript.prototype.initialize=function(){var a=this.getInitialStyleSheetUrls();a&&a.length>0&&this.injectStyleSheets(a)};Downsha.AbstractStyleScript.prototype.getInitialStyleSheetUrls=function(){return[]};Downsha.AbstractStyleScript.prototype.injectStyleSheets=function(a){for(var b=Downsha.Utils.getDocumentHead(document),c=0;c<a.length;c++){var d=a[c],e=document.createElement("link");
e.setAttribute("rel","stylesheet");e.setAttribute("type","text/css");e.setAttribute("href",d);b&&b.appendChild(e)}}})();
(function(){var a=null,b=false;Downsha.ContentClipper=function(c){a=Downsha.Logger.getInstance();a.level=Downsha.ContentClipper.LOG_LEVEL;a.level==Downsha.Logger.LOG_LEVEL_DEBUG&&(b=true);this.initialize(c)};Downsha.inherit(Downsha.ContentClipper,Downsha.AbstractStyleScript);Downsha.ContentClipper._instance=null;Downsha.ContentClipper.getInstance=function(){if(!this._instance)this._instance=new Downsha.ContentClipper;return this._instance};Downsha.ContentClipper.destroyInstance=function(){this._instance=
null};Downsha.ContentClipper.LOG_LEVEL=0;Downsha.ContentClipper.LOCALIZED_STYLE_TAG_ID="downshaChromeExtensionLocalizedStyleSheet";Downsha.ContentClipper.prototype.PREVIEW_ARTICLE_CLASS="downshaPreviewArticleContainer";Downsha.ContentClipper.prototype.SHOW_WAIT_CLIP_DELAY_TIME=300;Downsha.ContentClipper.prototype.WAIT_FADE_TIME=1E3;Downsha.ContentClipper.prototype.AFTER_INJECT_SIGNAL_DELAY_TIME=300;Downsha.ContentClipper.prototype.clip=null;Downsha.ContentClipper.prototype._localizedStyleSheets=null;
Downsha.ContentClipper.prototype._localizedStyleSheetCount=0;Downsha.ContentClipper.prototype._localizedStyleSheetsInjected=false;Downsha.ContentClipper.prototype._sema=null;Downsha.ContentClipper.prototype._article=null;Downsha.ContentClipper.prototype._articleRules=null;Downsha.ContentClipper.prototype.initialStyleSheetUrls=["chrome-extension://"+chrome.i18n.getMessage("@@extension_id")+"/css/contentclipper.css"];Downsha.ContentClipper.prototype.initialize=function(a){this.window=a?a:window;Downsha.ContentClipper.parent.initialize.apply(this,
[]);this._sema=Downsha.Semaphore.mutex();this.fetchArticleRules();this.isLocalizedStyleSheetsInjected()||this.localizeStyleSheets();this.__defineGetter__("article",this.getArticle);this.__defineGetter__("articleRules",this.getArticleRules)};Downsha.ContentClipper.prototype.getInitialStyleSheetUrls=function(){return this.initialStyleSheetUrls};Downsha.ContentClipper.prototype.PAGE_CLIP_SUCCESS=Downsha.Constants.RequestType.PAGE_CLIP_SUCCESS;Downsha.ContentClipper.prototype.PAGE_CLIP_CONTENT_TOO_BIG=
Downsha.Constants.RequestType.PAGE_CLIP_CONTENT_TOO_BIG;Downsha.ContentClipper.prototype.PAGE_CLIP_CONTENT_SUCCESS=Downsha.Constants.RequestType.PAGE_CLIP_CONTENT_SUCCESS;Downsha.ContentClipper.prototype.PAGE_CLIP_CONTENT_FAILURE=Downsha.Constants.RequestType.PAGE_CLIP_CONTENT_FAILURE;Downsha.ContentClipper.prototype.PAGE_CLIP_FAILURE=Downsha.Constants.RequestType.PAGE_CLIP_FAILURE;Downsha.ContentClipper.prototype.WAIT_CONTAINER_ID="downshaContentClipperWait";Downsha.ContentClipper.prototype.onClip=
function(a){(new Downsha.RequestMessage(this.PAGE_CLIP_SUCCESS,a.toDataObject())).send()};Downsha.ContentClipper.prototype.onClipContent=function(a){(new Downsha.RequestMessage(this.PAGE_CLIP_CONTENT_SUCCESS,a.toDataObject())).send()};Downsha.ContentClipper.prototype.onClipFailure=function(a){(new Downsha.RequestMessage(this.PAGE_CLIP_FAILURE,a)).send()};Downsha.ContentClipper.prototype.onClipContentFailure=function(a){(new Downsha.RequestMessage(this.PAGE_CLIP_CONTENT_FAILURE,a)).send()};Downsha.ContentClipper.prototype.onClipContentTooBig=
function(a){(new Downsha.RequestMessage(this.PAGE_CLIP_CONTENT_TOO_BIG,a.toDataObject())).send()};Downsha.ContentClipper.prototype.getArticleRules=function(){return this._articleRules};Downsha.ContentClipper.prototype.fetchArticleRules=function(){a.debug("ContentClipper.fetchArticleRules");var b=this;this._articleRules||this._sema.critical(function(){chrome.extension.sendRequest(new Downsha.RequestMessage(Downsha.Constants.RequestType.FETCH_ARTICLE_RULES,this.window.document.location.href),function(a){b._articleRules=
a&&a.rules?a.rules:{};b._sema.signal()})})};Downsha.ContentClipper.prototype.localizeStyleSheets=function(){a.debug("ContentClipper.localizeStyleSheets");var b=this;this._localizedStyleSheets=[];var d=this._localizedStyleSheetCount=this._localizedStyleSheets.count=0,e=function(){if(d==0){a.debug("Not injecting localized styles cuz there were none fetched");b._sema.signal()}else if(!b.isLocalizedStyleSheetsInjected()&&b._localizedStyleSheets.count==b._localizedStyleSheetCount){a.debug("Injecting "+
b._localizedStyleSheetCount+" localized style sheets");b._importExternalStyles(function(){b._injectLocalizedStyles();setTimeout(function(){b._sema.signal()},b.AFTER_INJECT_SIGNAL_DELAY_TIME)})}};this._sema.critical(function(){for(var f=0;f<document.styleSheets.length;f++)if(document.styleSheets[f].disabled)a.debug("Skipping disabled sheet");else if(document.styleSheets[f].media&&document.styleSheets[f].media.length>0&&document.styleSheets[f].media.mediaText&&document.styleSheets[f].media.mediaText.toLowerCase().indexOf("screen")<
0&&document.styleSheets[f].media.mediaText.toLowerCase().indexOf("all")<0)a.debug("Skipping style sheet cuz it's not for screen");else if(document.styleSheets[f].rules){var g=b.serializeStyleRules(document.styleSheets[f].rules);a.debug("Adding local rules, css text length: "+g.length);b._localizedStyleSheets[b._localizedStyleSheetCount++]=g;b._localizedStyleSheets.count++}else if(document.styleSheets[f].href&&document.styleSheets[f].href.toLowerCase().indexOf("http")==0){a.debug("Fetching remote style sheet: "+
document.styleSheets[f].href);g=function(a){b._localizedStyleSheets[arguments.callee._count]="/* "+arguments.callee._url+"*/\n"+(a&&a.cssText?a.cssText:"");b._localizedStyleSheets.count++;e()};g._count=b._localizedStyleSheetCount++;g._url=document.styleSheets[f].href;b.fetchStyleSheet(document.styleSheets[f].href,g);d++}else a.debug("Skipping style sheet: "+document.styleSheets[f].href)});e()};Downsha.ContentClipper.prototype.fetchStyleSheet=function(a,b){chrome.extension.sendRequest(new Downsha.RequestMessage(Downsha.Constants.RequestType.FETCH_STYLE_SHEET_RULES,
a),function(a){typeof b=="function"&&b(a)})};Downsha.ContentClipper.prototype.serializeStyleRules=function(a){for(var b="",e=0;e<a.length;e++)b=b+(a[e].cssText+"\n");return b};Downsha.ContentClipper.prototype.isLocalizedStyleSheets=function(){return this._localizedStyleSheets?true:false};Downsha.ContentClipper.prototype.getDocBase=function(){var a=document.location.protocol+"//"+document.location.hostname;return a=a.toLowerCase()};Downsha.ContentClipper.prototype._importExternalStyles=function(b){a.debug("ContentClipper._importExternalStyles");
this._importExternalStylesFromString(this._localizedStyleSheets.join("").replace(/\n+/,""),b)};Downsha.ContentClipper.prototype._importExternalStylesFromString=function(b,d){a.debug("ContentClipper._importExternalStylesFromString");var e=this;if(b){for(var f=/@import\s+url\(\s*[\'\"]?([^\'\"\)]+)[\'\"]?\s*\)\s*;?/ig,g=null,h=this.getDocBase(),i=0,j=function(){i==0&&typeof d=="function"&&d()};g=f.exec(b);){var k=g[1];k.toLowerCase().indexOf("http")<0&&(k=k.charAt(0)=="/"?h+k:document.location.href.replace(/\/[^\/]*$/,
"/"+k));if(k&&k.toLowerCase().indexOf(h)<0){a.debug("Fetching import: "+k);var l=function(b){var c=b&&b.cssText?b.cssText:"",d=arguments.callee._pattern;a.debug("Replacing: "+d+" with css text of length: "+c.length);if(d)for(var g=0;g<e._localizedStyleSheets.length;g++)e._localizedStyleSheets[g]=e._localizedStyleSheets[g].replace(d,c);i--;f.test(c.replace(/[\n\r]+/g,""))?e._importExternalStylesFromString(c,function(){j()}):j()};l._pattern=g[0];this.fetchStyleSheet(k,l);i++}else k?k.toLowerCase().indexOf(h)==
0&&a.debug("Skipping same-origin import: "+k):a.warn("Could not determine URL of import: "+g[0])}j()}};Downsha.ContentClipper.prototype._injectLocalizedStyles=function(){a.debug("ContentClipper._injectLocalizedStyles");var b=this._localizedStyleSheets.join("\n");if(b){var d=document.getElementById(this.constructor.LOCALIZED_STYLE_TAG_ID);d&&d.parentElement&&d.parentElement.removeChild(d);d=document.createElement("style");d.setAttribute("id",this.constructor.LOCALIZED_STYLE_TAG_ID);var e=document.createTextNode();
e.textContent=b;d.appendChild(e);document.head.appendChild(d)}};Downsha.ContentClipper.prototype.isLocalizedStyleSheetsInjected=function(){return document.getElementById(this.constructor.LOCALIZED_STYLE_TAG_ID)?true:false};Downsha.ContentClipper.prototype._doClip=function(a,b){var e=this;if(b){this.wait();setTimeout(function(){e._sema.critical(function(){a();e._sema.signal();e.clearWait()})},e.SHOW_WAIT_CLIP_DELAY_TIME)}else this._sema.critical(function(){a();e._sema.signal()})};Downsha.ContentClipper.prototype.perform=
function(a,b,e){var f=this;this._doClip(function(){f._perform(a,b)},e)};Downsha.ContentClipper.prototype.clipSelection=function(b,d,e){a.debug("ContentClipper.clipSelection");var f=this;this._doClip(function(){f._clipSelection(b,d)},e)};Downsha.ContentClipper.prototype.clipFullPage=function(b,d,e){a.debug("ContentClipper.clipFullPage");var f=this;this._doClip(function(){f._clipFullPage(b,d)},e)};Downsha.ContentClipper.prototype.clipArticle=function(b,d,e){a.debug("ContentClipper.clipArticle");var f=
this;this._doClip(function(){f._clipArticle(b,d)},e)};Downsha.ContentClipper.prototype.getArticleElement=function(){var a=this.window.document.getElementsByClassName(this.PREVIEW_ARTICLE_CLASS)[0];if(a)return a;if(this.article){Downsha.Utils.addElementClass(this.article,this.PREVIEW_ARTICLE_CLASS);return this.article}return null};Downsha.ContentClipper.prototype.getArticle=function(){if(!this._article)this._article=Downsha.Utils.getArticleNode(this.window.document,this.articleRules);return this._article};
Downsha.ContentClipper.prototype._clipSelection=function(b,d){a.debug("ContentClipper._clipSelection");this._perform(false,b,d)};Downsha.ContentClipper.prototype._clipFullPage=function(b,d){a.debug("ContentClipper._clipFullPage");this._perform(true,b,d)};Downsha.ContentClipper.prototype._clipArticle=function(c,d){a.debug("ContentClipper._clipArticle");this.createClipObject(c);var e=this.getArticleElement();a.debug("Article element: "+e);try{if(e&&this.clip.clipElement(e)){this._overloadClipNote(this.clip,
d);if(b){a.debug("Successful clip of element's contents: "+this.clip.toString());a.dir(this.clip.toDataObject())}if(this.clip.sizeExceeded||this.clip.length>=Downsha.Constants.Limits.CLIP_NOTE_CONTENT_LEN_MAX){b&&a.debug("Notifying full page clip failure");this.onClipContentTooBig(this.clip)}else this.onClipContent(this.clip)}else{b&&a.debug("Failed to clip contents of given element");this.onClipFailure(chrome.i18n.getMessage("articleClipFailure"))}}catch(f){b&&a.exception("Exception clipping page or its selection"+
(typeof f.message!="undefined"?": "+f.message:""));this.onClipFailure(f.message)}};Downsha.ContentClipper.prototype._overloadClipNote=function(c,d){if(c&&d){if(b){a.debug("Overloading attrs: ");a.dir(d)}for(var e in d)if(d[e]&&Downsha.hasOwnProperty(c,e))try{c[e]=d[e]}catch(f){}}};Downsha.ContentClipper.prototype.createClipObject=function(b){var d=this;this.clip=new Downsha.Clip(this.window,b,Downsha.Constants.Limits.CLIP_NOTE_CONTENT_LEN_MAX,this.articleRules);this.clip.onsizeexceed=function(){a.debug("Content size exceeded during serialization");
d.onClipContentTooBig(d.clip)};return this.clip};Downsha.ContentClipper.prototype._perform=function(c,d,e){b&&a.debug("Contentscript clipping...");this.createClipObject(d);b&&a.debug("CLIP: "+this.clip.toString());try{if(!c&&this.clip.hasSelection()&&this.clip.clipSelection()){this._overloadClipNote(this.clip,e);b&&a.debug("Successful clip of selection: "+this.clip.toString());if(this.clip.sizeExceeded||this.clip.length>=Downsha.Constants.Limits.CLIP_NOTE_CONTENT_LEN_MAX){b&&a.debug("Notifying full page clip failure");
this.onClipContentTooBig(this.clip)}else this.onClipContent(this.clip)}else if(!c&&this.article&&Downsha.Utils.isArticleSane(this.window.document.width,this.window.document.height,Downsha.Utils.getAbsoluteBoundingClientRect(this.article))&&this.clip.clipElement(this.article)){this._overloadClipNote(this.clip,e);if(b){a.debug("Successful clip of element's contents: "+this.clip.toString());a.dir(this.clip.toDataObject())}if(this.clip.sizeExceeded||this.clip.length>=Downsha.Constants.Limits.CLIP_NOTE_CONTENT_LEN_MAX){b&&
a.debug("Notifying full page clip failure");this.onClipContentTooBig(this.clip)}else this.onClipContent(this.clip)}else if(this.clip.hasBody()){this._overloadClipNote(this.clip,e);this.onClip(this.clip);b&&a.debug("Successful clip of full page: "+this.clip.toString());if(this.clip.clipBody())if(this.clip.sizeExceeded||this.clip.length>=Downsha.Constants.Limits.CLIP_NOTE_CONTENT_LEN_MAX){b&&a.debug("Notifying full page clip failure");this.onClipContentTooBig(this.clip)}else{b&&a.debug("Notifying full page clip success");
this.onClipContent(this.clip)}else this.onClipContentFailure(chrome.i18n.getMessage("fullPageClipFailure"))}else{b&&a.debug("Failed to clip full page");this.onClipFailure(chrome.i18n.getMessage("fullPageClipFailure"))}}catch(f){b&&a.debug("Exception clipping page or its selection"+(typeof f.message!="undefined"?": "+f.message:""));this.onClipFailure(f.message)}b&&a.debug("Done clipping...")};Downsha.ContentClipper.prototype.getWaitContainer=function(){var a=document.getElementById(this.WAIT_CONTAINER_ID);
if(!a){a=document.createElement("DOWNSHADIV");a.id=this.WAIT_CONTAINER_ID;var b=document.createElement("DIV");b.id=this.WAIT_CONTAINER_ID+"Content";a.appendChild(b);var e=document.createElement("CENTER");b.appendChild(e);b=document.createElement("IMG");b.setAttribute("src","chrome-extension://"+chrome.i18n.getMessage("@@extension_id")+"/images/icon_scissors.png");e.appendChild(b);b=document.createElement("SPAN");b.id=this.WAIT_CONTAINER_ID+"Text";e.appendChild(b);a._waitMsgBlock=b;a.setMessage=function(a){this._waitMsgBlock.innerHTML=
a}}return a};Downsha.ContentClipper.prototype.wait=function(){var a=this.getWaitContainer();a.style.opacity="1";a.setMessage(chrome.i18n.getMessage("contentclipper_clipping"));document.body.appendChild(a)};Downsha.ContentClipper.prototype.clearWait=function(){var a=document.getElementById(this.WAIT_CONTAINER_ID);if(a){a.style.opacity="0";setTimeout(function(){a.parentNode.removeChild(a)},this.WAIT_FADE_TIME)}}})();
