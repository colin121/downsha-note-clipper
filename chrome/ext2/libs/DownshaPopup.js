(function(){var b=null;Downsha.ViewManager=function(){b=Downsha.Logger.getInstance();this.__defineGetter__("quiet",this.isQuiet);this.__defineSetter__("quiet",this.setQuiet)};Downsha.ViewManager._instance=null;Downsha.ViewManager.FORM_FIELD_ERROR_CLASS="error";Downsha.ViewManager.FORM_FIELD_ERROR_MESSAGE_CLASS="error";Downsha.ViewManager.FORM_FIELD_ERROR_MESSAGE_ELEMENT="div";Downsha.ViewManager.PAGE_HEIGHT_DELTA=0;Downsha.ViewManager.getInstance=function(){this._instance||(this._instance=new Downsha.ViewManager);
return this._instance};Downsha.ViewManager.prototype.currentView=null;Downsha.ViewManager.prototype.globalMessage=null;Downsha.ViewManager.prototype.globalErrorMessage=null;Downsha.ViewManager.prototype._quiet=!1;Downsha.ViewManager.prototype.setQuiet=function(a){this._quiet=a?!0:!1};Downsha.ViewManager.prototype.isQuiet=function(){return this._quiet};Downsha.ViewManager.prototype.getEffectiveHeight=function(){b.debug("Downsha.ViewManager.getEffectiveHeight");var a=0;$("body > div").each(function(b,
c){var e=$(c);"none"!=e.css("display")&&!e.hasClass("banner")&&!e.hasClass("drawer")&&!e.hasClass("drawerHandleTitle")&&(a+=e.innerHeight())});a-=this.constructor.PAGE_HEIGHT_DELTA;0>a&&(a=0);return a};Downsha.ViewManager.prototype.updateBodyHeight=function(a){b.debug("Downsha.ViewManager.updateBodyHeight");a="number"==typeof a?a:this.getEffectiveHeight();$("body").animate({height:a+"px"},10)};Downsha.ViewManager.prototype.showBlock=function(a,b){a.show();b instanceof Array?a.trigger("show",b):a.trigger("show")};
Downsha.ViewManager.prototype.hideBlock=function(a,b){a.hide();b instanceof Array?a.trigger("hide",b):a.trigger("hide")};Downsha.ViewManager.prototype.showView=function(a,b){var c=a instanceof jQuery?a:$("#"+a);if(0==c.length)return null;this.showBlock(c,[b]);return c};Downsha.ViewManager.prototype.hideView=function(a){a=a instanceof jQuery?a:$("#"+a);if(0==a.length||"none"==a.css("display"))return null;this.hideBlock(a);this.currentView&&a.attr("id")==this.currentView.attr("id")&&(this.currentView=
null);return a};Downsha.ViewManager.prototype.switchView=function(a,d){b.debug("Downsha.ViewManager.switchView");var c=null,c=a instanceof jQuery?a:$("#"+a);if(this.currentView&&this.currentView.attr("id")==c.attr("id"))b.debug("Already showing...");else{this.currentView&&this.hideView(this.currentView.attr("id"));if(c=this.showView(a,d))this.currentView=c;return c}};Downsha.ViewManager.prototype.switchElements=function(a,b){a.hide();b.show()};Downsha.ViewManager.prototype.wait=function(a){var b=
$("#spinner");b.find("#spinnerMessage").html(a);b.show()};Downsha.ViewManager.prototype.clearWait=function(){$("#spinner").hide()};Downsha.ViewManager.prototype.showMessage=function(a){!this.quiet&&this.globalMessage&&(this.globalMessage.addMessage(a),this.globalMessage.show())};Downsha.ViewManager.prototype.hideMessage=function(a){this.globalMessage&&(this.globalMessage.removeMessage(a),0<this.globalMessage.length()?this.globalMessage.show():this.globalMessage.hide())};Downsha.ViewManager.prototype.hideAllMessages=
function(){this.globalMessage&&(this.globalMessage.removeAllMessages(),this.globalMessage.hide())};Downsha.ViewManager.prototype.extractErrorMessage=function(a,d){b.debug("Downsha.ViewManager.extractErrorMessage");var c="undefined"!=typeof d?d:null;b.debug("Error: "+a);a instanceof Downsha.DownshaError&&"number"==typeof a.errorCode&&"string"==typeof a.parameter&&this.getLocalizedMessage("DSTPError_"+(0>a.errorCode?-a.errorCode:a.errorCode)+"_"+a.parameter.replace(/[^a-zA-Z0-9_]+/g,"_"))?(b.debug("Got parameterized localized message for Downsha.DownshaError"),
c=this.getLocalizedMessage("DSTPError_"+(0>a.errorCode?-a.errorCode:a.errorCode)+"_"+a.parameter.replace(/[^a-zA-Z0-9_]+/g,"_"))):a instanceof Downsha.DSTPResponseException&&"number"==typeof a.errorCode&&this.getLocalizedMessage("DSTPResponseError_"+(0>a.errorCode?-a.errorCode:a.errorCode))?(b.debug("Got localized message for Downsha.DSTPResponseException"),c="string"==typeof a.parameter?this.getLocalizedMessage("DSTPResponseError_"+(0>a.errorCode?-a.errorCode:a.errorCode),a.parameter):this.getLocalizedMessage("DSTPResponseError_"+
(0>a.errorCode?-a.errorCode:a.errorCode))):a instanceof Downsha.DownshaError&&"number"==typeof a.errorCode&&this.getLocalizedMessage("DSTPError_"+(0>a.errorCode?-a.errorCode:a.errorCode))?(b.debug("Got localized message for Downsha.DownshaError"),c="string"==typeof a.parameter?this.getLocalizedMessage("DSTPError_"+(0>a.errorCode?-a.errorCode:a.errorCode),a.parameter):this.getLocalizedMessage("DSTPError_"+(0>a.errorCode?-a.errorCode:a.errorCode))):a instanceof Downsha.DownshaError&&"string"==typeof a.message?
(b.debug("Resorting to message included in the error"),c=a.message):(a instanceof Error||a instanceof Error)&&"string"==typeof a.message?(b.debug("Resorting to standard message"),c=a.message):"string"==typeof a&&(b.debug("Error is a string, so using that..."),c=a);return c};Downsha.ViewManager.prototype.showError=function(a){b.debug("Downsha.ViewManager.showError");this.quiet||(a=this.extractErrorMessage(a,this.getLocalizedMessage("UnknownError")),null!=a&&(this.globalErrorMessage.message=a,this.globalErrorMessage.show()))};
Downsha.ViewManager.prototype.showErrors=function(a){b.debug("Downsha.ViewManager.showErrors");if(!this.quiet){var d=a instanceof Array?a:[a];if(1==d.length)this.showError(d[0]);else{for(var c=this.getLocalizedMessage("multipleErrorsTitle"),e=$("<ul></ul>"),f=0;f<d.length;f++){var g=this.extractErrorMessage(a[f]);null!=g&&e.append("<li>"+g+"</li>")}0<e.children().length&&(a=$("<div class='multiErrorTitle'></div>"),a.append(c),a.append(e),this.globalErrorMessage.message=a,this.globalErrorMessage.show())}}};
Downsha.ViewManager.prototype.hideError=function(){this.globalErrorMessage.hide()};Downsha.ViewManager.prototype.hideErrors=function(){this.globalErrorMessage.hide()};Downsha.ViewManager.prototype.showHttpError=function(a,d,c){b.debug("Downsha.ViewManager.showHttpError");this.quiet||(a=this.getLocalizedHttpErrorMessage(a,d,c),this.showError(Error(a)))};Downsha.ViewManager.prototype.getLocalizedHttpErrorMessage=function(a,d,c){b.debug("Downsha.ViewManager.getLocalizedHttpErrorMessage");return 4==a.readyState?
this.getLocalizedMessage("Error_HTTP_Transport",[""+a.status,"string"==typeof c?c:""]):this.getLocalizedMessage("Error_HTTP_Transport",["readyState: "+a.readyState,""])};Downsha.ViewManager.prototype.getLocalizedMessage=function(a,b){return"undefined"!=typeof chrome&&"function"==typeof chrome.i18n.getMessage?chrome.i18n.getMessage(a,b):a};Downsha.ViewManager.prototype.showFormErrors=function(a,d,c){b.debug("Downsha.ViewManager.showFormErrors("+typeof a+", "+typeof d+")");if(!this.quiet)for(var a=
a instanceof jQuery?a:$(a),e=0;e<d.length;e++){var f=d[e],g=this.extractErrorMessage(f);b.debug(f.toString()+" => "+g);if("function"==typeof c)c("string"==typeof f.parameter?f.parameter:null,g);else{var h=null;"string"==typeof f.parameter&&null!=g&&(h=a.find("[name="+f.parameter+"]"),0==h.length&&(h=null));h?this.showFormFieldErrors(h,g):this.showError(g)}}};Downsha.ViewManager.prototype.showFormFieldErrors=function(a,d){b.debug("Downsha.ViewManager.showFormFieldError("+a+", "+d+")");this.quiet||
"undefined"==typeof a||(a instanceof jQuery||(a=$(a)),a.hasClass(this.constructor.FORM_FIELD_ERROR_CLASS)||a.addClass(this.constructor.FORM_FIELD_ERROR_CLASS),0==a.next("."+this.constructor.FORM_FIELD_ERROR_MESSAGE_CLASS).length?a.after($("<"+this.constructor.FORM_FIELD_ERROR_MESSAGE_ELEMENT+" class='"+this.constructor.FORM_FIELD_ERROR_MESSAGE_CLASS+"'>"+d+"</"+this.constructor.FORM_FIELD_ERROR_MESSAGE_ELEMENT+">")):a.next("."+this.constructor.FORM_FIELD_ERROR_MESSAGE_CLASS).html(d))};Downsha.ViewManager.prototype.clearFormArtifacts=
function(a){b.debug("Downsha.ViewManager.clearFormArtifacts");"undefined"!=typeof a&&(a instanceof jQuery||(a=$(a)),b.debug("Removing error messages..."),a.find("."+this.constructor.FORM_FIELD_ERROR_MESSAGE_CLASS).remove(),b.debug("Removing error classes from fields"),a.find("."+this.constructor.FORM_FIELD_ERROR_CLASS).removeClass(this.constructor.FORM_FIELD_ERROR_CLASS),b.debug("Done..."))};Downsha.ViewManager.SimpleMessage=function(a){this.initialize(a)};Downsha.ViewManager.SimpleMessage.MESSAGE_CLASS=
"simpleMessage";Downsha.ViewManager.SimpleMessage.prototype._container=null;Downsha.ViewManager.SimpleMessage.prototype._message=null;Downsha.ViewManager.SimpleMessage.prototype.initialize=function(a){this.__defineGetter__("container",this.getContainer);this.__defineGetter__("message",this.getMessage);this.__defineSetter__("message",this.setMessage);"undefined"!=typeof a&&a&&(this._container=a instanceof jQuery?a:$(a))};Downsha.ViewManager.SimpleMessage.prototype.getContainer=function(){return this._container};
Downsha.ViewManager.SimpleMessage.prototype.setMessage=function(a){this._message=a};Downsha.ViewManager.SimpleMessage.prototype.getMessage=function(){return this._message};Downsha.ViewManager.SimpleMessage.prototype.show=function(){if(this.message){var a=this.createMessageBlock();a.append(this.message);this._container.empty();this._container.append(a)}else this._container.empty();this._container.show()};Downsha.ViewManager.SimpleMessage.prototype.hide=function(){this._container.hide()};Downsha.ViewManager.SimpleMessage.prototype.createMessageBlock=
function(){return $("<div class='"+this.getMessageClass()+"'></div>")};Downsha.ViewManager.SimpleMessage.prototype.getMessageClass=function(){return Downsha.ViewManager.SimpleMessage.MESSAGE_CLASS};Downsha.ViewManager.StackableMessage=function(a){this.initialize(a)};Downsha.inherit(Downsha.ViewManager.StackableMessage,Downsha.ViewManager.SimpleMessage);Downsha.ViewManager.StackableMessage.MESSAGE_CLASS="stackableMessage";Downsha.ViewManager.StackableMessage.prototype._messageStack=[];Downsha.ViewManager.StackableMessage.prototype.initialize=
function(a){Downsha.ViewManager.StackableMessage.parent.initialize.apply(this,arguments)};Downsha.ViewManager.StackableMessage.prototype.getMessage=function(){return 0<this._messageStack.length?this._messageStack[this._messageStack.length-1]:null};Downsha.ViewManager.StackableMessage.prototype.setMessage=function(a){this._messageStack=[];this.addMessage(a)};Downsha.ViewManager.StackableMessage.prototype.addMessage=function(a){this._messageStack.push(this._describeMessage(a))};Downsha.ViewManager.StackableMessage.prototype.removeMessage=
function(a){for(var a=this._describeMessage(a),b=this._messageStack.length-1;0<=b;b--)if(this._messageStack[b]==a){this._messageStack.splice(b,1);break}};Downsha.ViewManager.StackableMessage.prototype.removeAllMessages=function(){this._messageStack=[]};Downsha.ViewManager.StackableMessage.prototype.length=function(){return this._messageStack.length};Downsha.ViewManager.StackableMessage.prototype._describeMessage=function(a){var b="";"string"==typeof a?b=a:a instanceof jQuery?a.each(function(a,e){b+=
this._describeMessage(e)}):a instanceof Text?b+=a:a instanceof HTMLElement&&(b+=a.innerHTML);return b};Downsha.ViewManager.StackableMessage.prototype.getMessageClass=function(){return Downsha.ViewManager.StackableMessage.parent.getMessageClass.apply(this)+" "+Downsha.ViewManager.StackableMessage.MESSAGE_CLASS}})();
(function(){Downsha.AbstractNoteForm=function(){};Downsha.AbstractNoteForm.TITLE="title";Downsha.AbstractNoteForm.CONTENT="content";Downsha.inherit(Downsha.AbstractNoteForm,jQuery);Downsha.AbstractNoteForm.onForm=function(b,a){var d={},c;for(c in this.prototype)d[c]=this.prototype[c];var e=b.get(0);$.extend(!0,b,d);b.form=$(e);b.__defineGetter__("title",b.getTitle);b.__defineSetter__("title",b.setTitle);b.__defineGetter__("content",b.getContent);b.__defineSetter__("content",b.setContent);if("object"==
typeof a&&null!=a)for(c in a)"string"==typeof this.prototype[c+"FieldName"]&&(this[c+"FieldName"]=a[c]);return b};Downsha.AbstractNoteForm.prototype.titleFieldName=Downsha.AbstractNoteForm.TITLE;Downsha.AbstractNoteForm.prototype.contentFieldName=Downsha.AbstractNoteForm.CONTENT;Downsha.AbstractNoteForm.prototype.getField=function(b){return this.form.find("*[name="+b+"]")};Downsha.AbstractNoteForm.prototype.getLabel=function(b){return this.form.find("label[for="+b+"]")};Downsha.AbstractNoteForm.prototype.enableField=
function(b){var a=this.getField(b);a&&("input"==a.prop("tagName").toLowerCase()?a.removeAttr("disabled"):a.removeClass("disabled"),(b=this.getLabel(b))&&b.hasClass("disabled")&&b.removeClass("disabled"))};Downsha.AbstractNoteForm.prototype.disableField=function(b){var a=this.getField(b);a&&("input"==a.prop("tagName").toLowerCase()?a.attr("disabled","disabled"):a.addClass("disabled"),(b=this.getLabel(b))&&!b.hasClass("disabled")&&b.addClass("disabled"))};Downsha.AbstractNoteForm.prototype.isFieldEnabled=
function(b){return(b=this.getField(b))&&!b.hasClass("disabled")};Downsha.AbstractNoteForm.prototype.getTitle=function(){return this.getField(this.titleFieldName).val()};Downsha.AbstractNoteForm.prototype.setTitle=function(b){this.getField(this.titleFieldName).val(b)};Downsha.AbstractNoteForm.prototype.getContent=function(){return this.getField(this.contentFieldName).val()};Downsha.AbstractNoteForm.prototype.setContent=function(b){this.getField(this.contentFieldName).val(b)};Downsha.AbstractNoteForm.prototype.reset=
function(){for(var b=this.getStorableProps(),a=0;a<b.length;a++)this[b[a]]=null};Downsha.AbstractNoteForm.prototype.populateWithNote=function(b,a){if(a instanceof Downsha.DownshaModel){var d=a.toStorable(),c;for(c in d)"undefined"!=typeof this[c]&&"undefined"!=typeof a[c]&&null!=a[c]&&(this[c]=a[c])}};Downsha.AbstractNoteForm.prototype.populateWith=function(b){this.reset();if(b instanceof Downsha.DownshaModel){var a=b.toStorable(),d;for(d in a)"undefined"!=typeof this[d]&&(this[d]=b[d])}};Downsha.AbstractNoteForm.prototype.getStorableProps=
function(){return["title","content"]};Downsha.AbstractNoteForm.prototype.toStorable=function(){for(var b=this.getStorableProps(),a={},d=0;d<b.length;d++)a[b[d]]=this[b[d]];return a};Downsha.AbstractNoteForm.prototype.getModelName=function(){return"Downsha.AbstractNoteForm"};Downsha.AbstractNoteForm.prototype.getStringDescription=function(){return"'"+this.title+"'; Content length: "+("string"==typeof this.content?this.content.length:0)};Downsha.AbstractNoteForm.prototype.toString=function(){return this.getModelName()+
" "+this.getStringDescription()}})();
(function(){Downsha.ClipNoteForm=function(){};Downsha.ClipNoteForm.URL="url";Downsha.inherit(Downsha.ClipNoteForm,Downsha.AbstractNoteForm);Downsha.ClipNoteForm.onForm=function(b,a){b=Downsha.ClipNoteForm.parent.constructor.onForm.apply(this,[b,a]);b.__defineGetter__("url",b.getUrl);b.__defineSetter__("url",b.setUrl);return b};Downsha.ClipNoteForm.prototype.urlFieldName=Downsha.ClipNoteForm.URL;Downsha.ClipNoteForm.prototype.getUrl=function(){return this.getField(this.urlFieldName).val()};Downsha.ClipNoteForm.prototype.setUrl=
function(b){this.getField(this.urlFieldName).val(b)};Downsha.ClipNoteForm.prototype.getStorableProps=function(){var b=Downsha.ClipNoteForm.parent.getStorableProps.apply(this);b.push("url");return b};Downsha.ClipNoteForm.prototype.populateWithNote=function(b,a){a instanceof Downsha.DownshaInfo&&Downsha.ClipNoteForm.parent.populateWithNote.apply(this,[b,a])};Downsha.ClipNoteForm.prototype.asClipNote=function(){return new Downsha.DownshaInfo(this.toStorable())};Downsha.ClipNoteForm.prototype.getModelName=
function(){return"Downsha.ClipNoteForm"};Downsha.ClipNoteForm.prototype.getStringDescription=function(){var b=Downsha.ClipNoteForm.parent.getStringDescription.apply(this);return b+="; URL: "+this.url}})();
(function(){var b=null,a=null;$(document).ready(function(){b=Downsha.Logger.getInstance();window.onerror=function(a,c,e){b.exception("\n"+c+":"+e+": "+a+"\n")};b.info("-------- POPUP STARTING ------------");chrome.windows.getCurrent(function(d){chrome.tabs.getSelected(d.id,function(c){a=new Downsha.ChromePopup(d,c);a.viewManager.wait(chrome.i18n.getMessage("loading"));setTimeout(function(){var d=c.url.match(/^(.*?):/)[1].toLowerCase();"http"!=d&&"https"!=d?(a.viewManager.clearWait(),a.viewManager.showBlock($("#header")),
a.viewManager.showError(chrome.i18n.getMessage("unsupportedScheme"))):chrome.extension.sendRequest(new Downsha.RequestMessage(Downsha.Constants.RequestType.FETCH_ARTICLE_RULES,c.url),function(){Downsha.context.userKnown?a.persistentLogin(function(){a.startUp()},function(c,d,e){a.popupStatus=Downsha.ChromePopup.POPUP_STATUS_CODES.STARTED;e instanceof Downsha.DSTPResponse&&e.hasAuthenticationError()?(b.info("Present login screen due to authentication error on initial login"),a.viewManager.switchView("loginView")):
e instanceof Downsha.DSTPResponse&&e.isError()?(a.viewManager.showBlock($("#header")),a.viewManager.showErrors([e.error])):Downsha.chromeExtension.offline?(a.viewManager.showBlock($("#header")),a.viewManager.showHttpError(c,d,e)):(a.viewManager.showBlock($("#header")),a.viewManager.showError(chrome.i18n.getMessage("UnknownError")))}):(a.viewManager.clearWait(),a.viewManager.switchView("loginView"))})},100)})})})})();
(function(){var b=null;Downsha.ChromePopup=function(a,d){b=Downsha.Logger.getInstance();this.initialize(a,d)};Downsha.ChromePopup.POPUP_DISMISS_TIMEOUT=300;Downsha.ChromePopup.QUICK_NOTE_VIEW_DEFAULTS={infoItem:null,fullPageEnabled:!0,notebookGuid:null};Downsha.ChromePopup.POPUP_STATUS_CODES={STARTUP:0,STARTED:1};Downsha.ChromePopup.prototype.window=null;Downsha.ChromePopup.prototype.tab=null;Downsha.ChromePopup.prototype.viewManager=null;Downsha.ChromePopup.prototype.aborted=!1;Downsha.ChromePopup.prototype.options=
null;Downsha.ChromePopup.prototype.loginValidator=null;Downsha.ChromePopup.prototype.registerValidator=null;Downsha.ChromePopup.prototype.quickNoteValidator=null;Downsha.ChromePopup.prototype.quickNoteForm=null;Downsha.ChromePopup.prototype.loginProc=null;Downsha.ChromePopup.prototype.quickNoteSubmitWait=null;Downsha.ChromePopup.prototype._eventHandler=null;Downsha.ChromePopup.prototype._previewAdjustmentEnabled=!1;Downsha.ChromePopup.prototype.popupStatus=Downsha.ChromePopup.POPUP_STATUS_CODES.STARTUP;
Downsha.ChromePopup.prototype.initialize=function(a,d){b.debug("Initializing...");this.window=a;this.tab=d;this.initOptions();this.initEventHandler();this.initListeners();this.initViewManager();this.localizePopup();this.initForms();this.initViews();b.debug("initialized")};Downsha.ChromePopup.prototype.initOptions=function(){b.debug("Popup.initOptions");this.options=Downsha.context.options;this.options instanceof Downsha.Options&&(b.level=this.options.debugLevel)};Downsha.ChromePopup.prototype.initEventHandler=
function(){this._eventHandler||(this._eventHandler=new Downsha.EventHandler(this),this._eventHandler.defaultHandler=function(){b.info("Popup ignores request via defaultHandler...")},this._eventHandler.add(Downsha.Constants.RequestType.CONTENT_SCRIPT_LOAD_TIMEOUT,this.handleCancelPageClipTimer),this._eventHandler.add(Downsha.Constants.RequestType.PAGE_INFO,this.handlePageInfo))};Downsha.ChromePopup.prototype.initListeners=function(){b.debug("Popup.initListeners");var a=this;chrome.extension.onRequest.addListener(function(b,
c,e){a.handleRequest(b,c,e)})};Downsha.ChromePopup.prototype.initViewManager=function(){b.debug("Popup.initViewManager");this.viewManager=Downsha.ViewManager.getInstance();this.viewManager.globalErrorMessage=new Downsha.ViewManager.SimpleMessage($("#globalErrorMessage"));this.viewManager.globalMessage=new Downsha.ViewManager.StackableMessage($("#globalMessage"))};Downsha.ChromePopup.prototype.initViews=function(){b.debug("Popup.initViews");this.bindViews()};Downsha.ChromePopup.prototype.initForms=
function(){b.debug("Popup.initForms");this.quickNoteForm=Downsha.ClipNoteForm.onForm($("form[name=quickNoteForm]"));this.bindForms()};Downsha.ChromePopup.prototype.handleRequest=function(a,d,c){b.debug("Popup.handleRequest");if("object"==typeof a&&null!=a){var e=Downsha.RequestMessage.fromObject(a);e.isEmpty()||this._eventHandler.handleEvent(e.code,[a,d,c])}};Downsha.ChromePopup.prototype.handleCancelPageClipTimer=function(){b.debug("Popup.handleCancelPageClipTimer");this.viewManager.clearWait();
this.viewManager.showError(chrome.i18n.getMessage("contentScriptTimedOut"));this.startUpWithQuickNote(this.tab)};Downsha.ChromePopup.prototype.handlePageInfo=function(a,b,c){a=Downsha.RequestMessage.fromObject(a);a.message&&a.message.pageInfo&&(this.pageInfo=a.message.pageInfo,this.viewManager.clearWait(),this._startUp());c({})};Downsha.ChromePopup.prototype.localizePopup=function(){b.debug("Popup.localizePopup");for(var a=$("body"),d=0;d<a.length;d++){var c=$(a.get(d));Downsha.Utils.localizeBlock(c)}};
Downsha.ChromePopup.prototype.startUp=function(){b.debug("Popup.startUp");chrome.extension.sendRequest(new Downsha.RequestMessage(Downsha.Constants.RequestType.POPUP_STARTED));var a=new Downsha.PageInfo;Downsha.Utils.isForbiddenUrl(this.tab.url)?this.handlePageInfo(new Downsha.RequestMessage(Downsha.Constants.RequestType.PAGE_INFO,{pageInfo:a}),this,function(){}):a.profile(this.tab.id,function(){b.debug("Finished getting PageInfo")})};Downsha.ChromePopup.prototype._startUp=function(){b.debug("ChromePopup._startUp");
this.popupStatus=Downsha.ChromePopup.POPUP_STATUS_CODES.STARTED;this.startUpWithQuickNote(this.tab)};Downsha.ChromePopup.prototype.startUpWithQuickNote=function(a){b.debug("Popup.startUpWithQuickNote");var d={infoItem:new Downsha.DownshaInfo,fullPageEnabled:!1};if(a&&"string"==typeof a.title&&("string"!=typeof a.url||"string"==typeof a.url&&a.title!=a.url))d.infoItem.title=a.title;a&&"string"==typeof a.url&&(d.infoItem.url=a.url);this.viewManager.switchView("quickNoteView",d)};Downsha.ChromePopup.prototype.bindViews=
function(){b.debug("Popup.bindViews");this.bindHeader();this.bindLoginView();this.bindRegisterView();this.bindQuickNoteView()};Downsha.ChromePopup.prototype.bindHeader=function(){var a=this;$("#header").bind("show",function(){b.debug("#header.onShow");$("#headerLogoHome").unbind("click");$("#headerLogoHome").bind("click",function(){a.goHome()})})};Downsha.ChromePopup.prototype.bindPlatform=function(){var a=this;$(".platform_desktop").unbind("click");$(".platform_desktop").bind("click",function(){a.goDesktop()});
$(".platform_mobile").unbind("click");$(".platform_mobile").bind("click",function(){a.goMobile()});$(".platform_windows8").unbind("click");$(".platform_windows8").bind("click",function(){a.goWindows8()});$(".platform_chrome").unbind("click");$(".platform_chrome").bind("click",function(){a.goChrome()});$(".platform_firefox").unbind("click");$(".platform_firefox").bind("click",function(){a.goFirefox()});$(".platform_ie").unbind("click");$(".platform_ie").bind("click",function(){a.goDesktop()})};Downsha.ChromePopup.prototype.bindLoginView=
function(){var a=this;$("#loginView").bind("show",function(d,c){b.debug("#loginView.onShow");a.viewManager.showBlock($("#header"));$("#headerUser").hide();$("#headerNoUserLogin").hide();$("#headerNoUserRegister").show();$("#headerRegister").unbind("click");$("#headerRegister").bind("click",function(){a.goRegister()});a.updateBadge();a.bindPlatform();var e=$("#loginView").find("form[name=loginForm]");"object"==typeof c&&null!=c?("undefined"!=typeof c.username&&e.find("input[name=username]").val(c.username),
"undefined"!=typeof c.password&&e.find("input[name=password]").val(c.password)):e.find("input[type=password]").val("");e.find("input[name=username]").focus();a.loginValidator.focusInvalid()});$("#loginView").bind("hide",function(){b.debug("#loginView.onHide");a.viewManager.hideBlock($("#header"))})};Downsha.ChromePopup.prototype.bindRegisterView=function(){var a=this;$("#registerView").bind("show",function(d,c){b.debug("#registerView.onShow");a.viewManager.showBlock($("#header"));$("#headerUser").hide();
$("#headerNoUserRegister").hide();$("#headerNoUserLogin").show();$("#headerLogin").unbind("click");$("#headerLogin").bind("click",function(){a.goLogin()});a.updateBadge();a.bindPlatform();var e=$("#registerView").find("form[name=registerForm]");"object"==typeof c&&null!=c&&"undefined"!=typeof c.username&&e.find("input[name=username]").val(c.username);e.find("input[type=password]").val("");e.find("input[name=username]").focus();a.registerValidator.focusInvalid()});$("#registerView").bind("hide",function(){b.debug("#registerView.onHide");
a.viewManager.hideBlock($("#header"))})};Downsha.ChromePopup.prototype.bindQuickNoteView=function(){var a=this,d=$("#quickNoteView");d.bind("show",function(c,d){b.debug("#quickNoteView.onShow");a.viewManager.showBlock($("#header"));var f=Downsha.context.userName;f&&($("#headerUsername").text(f),$("#headerSignout").unbind("click"),$("#headerSignout").bind("click",function(){a.logout()}),$("#headerNoUserRegister").hide(),$("#headerNoUserLogin").hide(),$("#headerUser").show());a.bindPlatform();$("#platformFrame").attr("src",
Downsha.context.getNoteListUrl());$("#quickNoteArticleExpand").unbind("click");$("#quickNoteArticleExpand").bind("click",function(){Downsha.Utils.notifyExtension(new Downsha.RequestMessage(Downsha.Constants.RequestType.PREVIEW_NUDGE,{tabId:a.tab.id,direction:Downsha.Constants.RequestType.PREVIEW_NUDGE_PARENT}))});$("#quickNoteArticleShrink").unbind("click");$("#quickNoteArticleShrink").bind("click",function(){Downsha.Utils.notifyExtension(new Downsha.RequestMessage(Downsha.Constants.RequestType.PREVIEW_NUDGE,
{tabId:a.tab.id,direction:Downsha.Constants.RequestType.PREVIEW_NUDGE_CHILD}))});$("#quickNoteArticlePrev").unbind("click");$("#quickNoteArticlePrev").bind("click",function(){Downsha.Utils.notifyExtension(new Downsha.RequestMessage(Downsha.Constants.RequestType.PREVIEW_NUDGE,{tabId:a.tab.id,direction:Downsha.Constants.RequestType.PREVIEW_NUDGE_PREVIOUS_SIBLING}))});$("#quickNoteArticleNext").unbind("click");$("#quickNoteArticleNext").bind("click",function(){Downsha.Utils.notifyExtension(new Downsha.RequestMessage(Downsha.Constants.RequestType.PREVIEW_NUDGE,
{tabId:a.tab.id,direction:Downsha.Constants.RequestType.PREVIEW_NUDGE_NEXT_SIBLING}))});f=a.getQuickNoteActionElement();if(Downsha.Utils.isForbiddenUrl(a.tab.url))f.find("input").each(function(a,b){var c=$(b);c.val()!="CLIP_ACTION_URL"&&c.remove()}),f.find("label").each(function(a,b){var c=$(b);c.attr("for")!="CLIP_ACTION_URL"&&c.remove()});else{if(!a.pageInfo||!a.pageInfo.selection)f.find("input[value=CLIP_ACTION_SELECTION]").remove(),f.find("label[for=CLIP_ACTION_SELECTION]").remove();a.isArticleSane()||
(f.find("input[value=CLIP_ACTION_ARTICLE]").remove(),f.find("label[for=CLIP_ACTION_ARTICLE]").remove());if(!a.pageInfo||!(0<a.pageInfo.documentLength||a.pageInfo.containsImages))f.find("input[value=CLIP_ACTION_FULL_PAGE]").remove(),f.find("label[for=CLIP_ACTION_FULL_PAGE]").remove()}var f=(f=Downsha.context.getOptions(!0))&&f.clipAction?f.clipAction:Downsha.Options.CLIP_ACTION_OPTIONS.ARTICLE,g=null,g=Downsha.Utils.isForbiddenUrl(a.tab.url)?"CLIP_ACTION_URL":a.pageInfo&&a.pageInfo.selection?"CLIP_ACTION_SELECTION":
a.pageInfo&&a.pageInfo.article&&a.isArticleSane()&&f==Downsha.Options.CLIP_ACTION_OPTIONS.ARTICLE?"CLIP_ACTION_ARTICLE":a.pageInfo&&(0<a.pageInfo.documentLength||a.pageInfo.containsImages)&&(f==Downsha.Options.CLIP_ACTION_OPTIONS.ARTICLE||f==Downsha.Options.CLIP_ACTION_OPTIONS.FULL_PAGE)?"CLIP_ACTION_FULL_PAGE":"CLIP_ACTION_URL";a.selectQuickNoteAction(g);a.updateQuickNoteAction();f=$.extend(!0,{},Downsha.ChromePopup.QUICK_NOTE_VIEW_DEFAULTS);a.quickNoteForm.populateWith(f);d&&"object"==typeof d?
(b.debug("Overriding quick note form with passed arguments"),"object"==typeof d.infoItem?(b.debug("Using supplied infoItem object to populate quick note form"),g=d.infoItem instanceof Downsha.DownshaInfo?d.infoItem:new Downsha.DownshaInfo(d.infoItem),a.quickNoteForm.populateWithNote(Downsha.context,g)):b.debug("No infoItem object passed, using as a blank quick note"),$.extend(!0,f,d)):b.debug("No options were given, will operate as quick note with default options");$("#quickNoteView input[type=submit]").focus()});
d.bind("hide",function(){b.debug("#quickNoteView.onHide");a.viewManager.hideBlock($("#header"))})};Downsha.ChromePopup.prototype.bindForms=function(){b.debug("Adding expression method");$.validator.addMethod("mask",$.fn.validate.methods.mask,chrome.i18n.getMessage("invalidMask"));$.validator.addMethod("trim",$.fn.validate.methods.trim,"trim error");$.validator.addMethod("totalPartsRange",$.fn.validate.methods.totalPartsRange,chrome.i18n.getMessage("totalPartsNotInRange"));$.validator.addMethod("partLengthRange",
$.fn.validate.methods.partLengthRange,chrome.i18n.getMessage("partLengthNotInRange"));$.validator.addMethod("partMask",$.fn.validate.methods.partMask);$.validator.addMethod("toLowerCase",$.fn.validate.methods.toLowerCase);$.validator.addMethod("anyOf",$.fn.validate.methods.toLowerCase);$.validator.prototype.invalidate=function(a,b){var c={};c[a]=b;this.showErrors(c)};this.bindLoginForm();this.bindRegisterForm();this.bindQuickNoteForm()};Downsha.ChromePopup.prototype.bindLoginForm=function(){b.debug("Popup.bindLoginForm");
var a=$("form[name=loginForm]"),d=this;if(0==a.length)b.warn("Could not find login form");else{var c={submitHandler:function(){d.submitLoginForm()},errorClass:this.viewManager.FORM_FIELD_ERROR_MESSAGE_CLASS,errorElement:"div",onkeyup:!1,onfocusout:!1,invalidHandler:function(){},success:function(){},rules:{username:{required:!0,minlength:Downsha.Constants.Limits.DSTP_USER_NAME_LEN_MIN,maxlength:Downsha.Constants.Limits.DSTP_USER_NAME_LEN_MAX,mask:Downsha.Constants.Limits.DSTP_USER_NAME_REGEX},password:{required:!0,
minlength:Downsha.Constants.Limits.DSTP_USER_PWD_LEN_MIN,maxlength:Downsha.Constants.Limits.DSTP_USER_PWD_LEN_MAX,mask:Downsha.Constants.Limits.DSTP_USER_PWD_REGEX}},messages:{username:{required:chrome.i18n.getMessage("valueNotPresent",chrome.i18n.getMessage("loginForm_username")),minlength:chrome.i18n.getMessage("valueTooShort",[chrome.i18n.getMessage("loginForm_username"),Downsha.Constants.Limits.DSTP_USER_NAME_LEN_MIN]),maxlength:chrome.i18n.getMessage("valueTooLong",[chrome.i18n.getMessage("loginForm_username"),
Downsha.Constants.Limits.DSTP_USER_NAME_LEN_MAX]),mask:chrome.i18n.getMessage("invalidUsername")},password:{required:chrome.i18n.getMessage("valueNotPresent",chrome.i18n.getMessage("loginForm_password")),minlength:chrome.i18n.getMessage("valueTooShort",[chrome.i18n.getMessage("loginForm_password"),Downsha.Constants.Limits.DSTP_USER_PWD_LEN_MIN]),maxlength:chrome.i18n.getMessage("valueTooLong",[chrome.i18n.getMessage("loginForm_password"),Downsha.Constants.Limits.DSTP_USER_PWD_LEN_MAX]),mask:chrome.i18n.getMessage("invalidPassword")}}};
b.debug("Setting up validation on login form");this.loginValidator=a.validate(c)}};Downsha.ChromePopup.prototype.bindRegisterForm=function(){b.debug("Popup.bindRegisterForm");var a=$("form[name=registerForm]"),d=this;if(0==a.length)b.warn("Could not find register form");else{var c={submitHandler:function(){d.submitRegisterForm()},errorClass:this.viewManager.FORM_FIELD_ERROR_MESSAGE_CLASS,errorElement:"div",onkeyup:!1,onfocusout:!1,invalidHandler:function(){},success:function(){},rules:{username:{required:!0,
minlength:Downsha.Constants.Limits.DSTP_USER_NAME_LEN_MIN,maxlength:Downsha.Constants.Limits.DSTP_USER_NAME_LEN_MAX,mask:Downsha.Constants.Limits.DSTP_USER_NAME_REGEX},password:{required:!0,minlength:Downsha.Constants.Limits.DSTP_USER_PWD_LEN_MIN,maxlength:Downsha.Constants.Limits.DSTP_USER_PWD_LEN_MAX,mask:Downsha.Constants.Limits.DSTP_USER_PWD_REGEX},password2:{required:!0,equalTo:"#registerPassword",minlength:Downsha.Constants.Limits.DSTP_USER_PWD_LEN_MIN,maxlength:Downsha.Constants.Limits.DSTP_USER_PWD_LEN_MAX,
mask:Downsha.Constants.Limits.DSTP_USER_PWD_REGEX}},messages:{username:{required:chrome.i18n.getMessage("valueNotPresent",chrome.i18n.getMessage("registerForm_username")),minlength:chrome.i18n.getMessage("valueTooShort",[chrome.i18n.getMessage("registerForm_username"),Downsha.Constants.Limits.DSTP_USER_NAME_LEN_MIN]),maxlength:chrome.i18n.getMessage("valueTooLong",[chrome.i18n.getMessage("registerForm_username"),Downsha.Constants.Limits.DSTP_USER_NAME_LEN_MAX]),mask:chrome.i18n.getMessage("invalidUsername")},
password:{required:chrome.i18n.getMessage("valueNotPresent",chrome.i18n.getMessage("registerForm_password")),minlength:chrome.i18n.getMessage("valueTooShort",[chrome.i18n.getMessage("registerForm_password"),Downsha.Constants.Limits.DSTP_USER_PWD_LEN_MIN]),maxlength:chrome.i18n.getMessage("valueTooLong",[chrome.i18n.getMessage("registerForm_password"),Downsha.Constants.Limits.DSTP_USER_PWD_LEN_MAX]),mask:chrome.i18n.getMessage("invalidPassword")},password2:{required:chrome.i18n.getMessage("valueNotPresent",
chrome.i18n.getMessage("registerForm_password")),equalTo:chrome.i18n.getMessage("valueNotEqualTo",chrome.i18n.getMessage("registerForm_password")),minlength:chrome.i18n.getMessage("valueTooShort",[chrome.i18n.getMessage("registerForm_password"),Downsha.Constants.Limits.DSTP_USER_PWD_LEN_MIN]),maxlength:chrome.i18n.getMessage("valueTooLong",[chrome.i18n.getMessage("registerForm_password"),Downsha.Constants.Limits.DSTP_USER_PWD_LEN_MAX]),mask:chrome.i18n.getMessage("invalidPassword")}}};b.debug("Setting up validation on register form");
this.registerValidator=a.validate(c)}};Downsha.ChromePopup.prototype.bindQuickNoteForm=function(){b.debug("Popup.bindQuickNoteForm");var a=$("form[name=quickNoteForm]");if(0==a.length)b.warn("Could not find quickNoteForm");else{var d=a.find("input[name=title]");d.bind("blur",function(){d.val(d.val().trim())});var c=this;this.getQuickNoteActionElement().find("input").each(function(a,b){$(b).bind("click",function(){c.updateQuickNoteAction()})});var e={submitHandler:function(){c.submitQuickNoteForm()},
errorClass:this.viewManager.FORM_FIELD_ERROR_MESSAGE_CLASS,errorElement:"div",onkeyup:!1,onfocusin:function(){c.disablePreviewAdjustment()},onfocusout:function(){c.enablePreviewAdjustment();c.quickNoteValidator.numberOfInvalids()&&c.quickNoteValidator.form()},rules:{title:{trim:!0,required:!1,rangelength:[Downsha.Constants.Limits.DSTP_NOTE_TITLE_LEN_MIN,Downsha.Constants.Limits.DSTP_NOTE_TITLE_LEN_MAX],mask:Downsha.Constants.Limits.DSTP_NOTE_TITLE_REGEX},tagNames:{totalPartsRange:[Downsha.Constants.Limits.DSTP_NOTE_TAGS_MIN,
Downsha.Constants.Limits.DSTP_NOTE_TAGS_MAX],partLengthRange:[Downsha.Constants.Limits.DSTP_TAG_NAME_LEN_MIN,Downsha.Constants.Limits.DSTP_TAG_NAME_LEN_MAX],partMask:Downsha.Constants.Limits.DSTP_TAG_NAME_REGEX}},messages:{title:{rangelength:chrome.i18n.getMessage("valueNotInRange",[chrome.i18n.getMessage("quickNote_title"),Downsha.Constants.Limits.DSTP_NOTE_TITLE_LEN_MIN,Downsha.Constants.Limits.DSTP_NOTE_TITLE_LEN_MAX]),mask:chrome.i18n.getMessage("invalidTitle")},tagNames:{totalPartsRange:chrome.i18n.getMessage("tagNamesNotInRange",
[Downsha.Constants.Limits.DSTP_NOTE_TAGS_MIN,Downsha.Constants.Limits.DSTP_NOTE_TAGS_MAX]),partLengthRange:chrome.i18n.getMessage("tagNameNotInRange",[Downsha.Constants.Limits.DSTP_TAG_NAME_LEN_MIN,Downsha.Constants.Limits.DSTP_TAG_NAME_LEN_MAX]),partMask:chrome.i18n.getMessage("invalidTagName")}}};b.debug("Setting up validation on quicknote form");this.quickNoteValidator=a.validate(e)}};Downsha.ChromePopup.prototype.submitLoginForm=function(){b.debug("Popup.submitLoginForm");var a=this.getLoginForm();
this.viewManager.hideErrors();this.viewManager.clearFormArtifacts(a);this.loginWithForm(a)};Downsha.ChromePopup.prototype.getLoginForm=function(){return $("form[name=loginForm]")};Downsha.ChromePopup.prototype.loginWithForm=function(a){b.debug("ChromePopup.loginWithForm");if("object"==typeof a){this.unabort();var d=a.find("[name=username]").val(),a=a.find("[name=password]").val();this.viewManager.wait(chrome.i18n.getMessage("loggingIn"));b.info("login as: "+d);this._login(d,a,!0)}};Downsha.ChromePopup.prototype._login=
function(a,d,c){b.debug("ChromePopup._login");var e=this;Downsha.context.rememberedSession=c;var f=this.getLoginForm();this.viewManager.wait(chrome.i18n.getMessage("loggingIn"));this.loginProc=Downsha.context.remote.login(a,d,c,function(c){b.info("login response received...");e.viewManager.clearWait();c.isSuccess()?(b.info("Successfully logged in"),e.viewManager.hideView("loginView"),b.debug("Updating stored username and password."),Downsha.context.userId=c.data.UID,Downsha.context.userName=a,Downsha.context.userPass=
Downsha.XORCrypt.encrypt(d,a),Downsha.context.termId=c.data.TID,1!=parseInt(c.data.ResyncTerm)?e.startUp():(b.info("notify terminal information..."),Downsha.context.remote.notifyTermInfo(Downsha.platform.toJSON(),function(){b.info("notify terminal ok");e.startUp()},function(){b.info("notify terminal failed");e.startUp()},!0))):c.isError()&&(c.error?(b.info("login invalid"),e.loginValidator.resetForm(),e.viewManager.showFormErrors(f,[c.error],null)):(b.warn("Unexpected response during login"),e.viewManager.showErrors(c.error)),
e.viewManager.switchView("loginView",{username:a,password:""}))},function(a,c,d){a&&4==a.readyState?b.error("Failed to login due to transport problems (status: "+a.status+")"):a?b.error("Failed to login due to transport problems (readyState: "+a.readyState+")"):b.error("Failed to login due to unkonwn transport problems");e.viewManager.clearWait();e.viewManager.showHttpError(a,c,d)},!0)};Downsha.ChromePopup.prototype.submitRegisterForm=function(){b.debug("Popup.submitRegisterForm");var a=this.getRegisterForm();
this.viewManager.hideErrors();this.viewManager.clearFormArtifacts(a);this.registerWithForm(a)};Downsha.ChromePopup.prototype.getRegisterForm=function(){return $("form[name=registerForm]")};Downsha.ChromePopup.prototype.registerWithForm=function(a){b.debug("ChromePopup.registerWithForm");if("object"==typeof a){this.unabort();var d=a.find("[name=username]").val(),a=a.find("[name=password]").val();this.viewManager.wait(chrome.i18n.getMessage("registering"));b.info("register as: "+d);this._register(d,
a)}};Downsha.ChromePopup.prototype._register=function(a,d){b.debug("ChromePopup._register");var c=this,e=this.getRegisterForm();this.viewManager.wait(chrome.i18n.getMessage("registering"));this.registerProc=Downsha.context.remote.register(a,d,function(f){b.info("register response received...");c.viewManager.clearWait();f.isSuccess()?(b.info("Successfully registered"),c.viewManager.hideView("registerView"),b.debug("Updating stored username and password."),Downsha.context.userId=f.data.UID,Downsha.context.userName=
a,Downsha.context.userPass=Downsha.XORCrypt.encrypt(d,a),Downsha.context.termId=f.data.TID,1!=parseInt(f.data.ResyncTerm)?c.startUp():(b.info("notify terminal information..."),Downsha.context.remote.notifyTermInfo(Downsha.platform.toJSON(),function(){b.info("notify terminal ok");c.startUp()},function(){b.info("notify terminal failed");c.startUp()},!0))):f.isError()&&(f.error?(b.info("register invalid"),c.registerValidator.resetForm(),c.viewManager.showFormErrors(e,[f.error],null)):(b.warn("Unexpected response during register"),
c.viewManager.showErrors(f.error)),c.viewManager.switchView("registerView",{username:a,password:""}))},function(a,d,e){a&&4==a.readyState?b.error("Failed to register due to transport problems (status: "+a.status+")"):a?b.error("Failed to register due to transport problems (readyState: "+a.readyState+")"):b.error("Failed to register due to unkonwn transport problems");c.viewManager.clearWait();c.viewManager.showHttpError(a,d,e)},!0)};Downsha.ChromePopup.prototype.logout=function(a){b.debug("ChromePopup.logout");
this.viewManager.wait(chrome.i18n.getMessage("loggingOut"));b.info("Logging out...");var d=this;"function"!=typeof a&&(a=function(){d.viewManager.clearWait();d.viewManager.switchView("loginView")});var c=function(){d.viewManager.clearWait();(new Downsha.RequestMessage(Downsha.Constants.RequestType.LOGOUT,{resetOptions:!0})).send();a()};Downsha.context.remote.logout(function(a){d.viewManager.clearWait();a instanceof Downsha.DSTPResponse&&a.isSuccess()?b.info("Successfully logged out"):b.error("Got garbage response when tried to logout");
c()},function(a){a&&4==a.readyState?b.error("Failed to log out due to transport errors (status: "+a.status+")"):a?b.error("Failed to log out due to transport errors (readyState: "+a.readyState+")"):b.error("Failed to log out due to unknown transport errors");d.viewManager.clearWait();c()},!0)};Downsha.ChromePopup.prototype.persistentLogin=function(a,d){b.debug("Popup.persistentLogin");this.viewManager.wait(chrome.i18n.getMessage("loggingIn"));var c=this;return Downsha.context.remote.assureLogin(function(e,
f,g){c.viewManager.clearWait();e instanceof Downsha.DSTPResponse&&e.isSuccess()?(b.info("Got successful result on login"),"function"==typeof a&&a(e,f)):(b.info("Got error result on login"),"function"==typeof d&&d(g,f,e))},function(a,f,g){a&&4==a.readyState?b.error("Failed to login due to transport errors (status: "+a.status+")"):a?b.error("Failed to login due to transport errors (readyState: "+a.readyState+")"):b.error("Failed to login due to unknown transport errors");c.viewManager.clearWait();"function"==
typeof d&&d(a,f,g)})};Downsha.ChromePopup.prototype.submitQuickNoteForm=function(){b.debug("Popup.submitQuickNoteForm");var a=this;if(this.quickNoteForm){b.debug("Grabbing data from form");this.viewManager.hideErrors();var d=this.quickNoteForm.asClipNote();d.title||(d.title=chrome.i18n.getMessage("quickNote_untitledNote"));delete d.content;this.viewManager.hideView("quickNoteView");this.abortProcs();Downsha.chromeExtension.contentPreview.clear(this.tab.id,function(){var b=a.getQuickNoteAction();if(b==
"CLIP_ACTION_FULL_PAGE")Downsha.chromeExtension.clipFullPageFromTab(a.tab,d);else if(b=="CLIP_ACTION_SELECTION")Downsha.chromeExtension.clipSelectionFromTab(a.tab,d);else if(b=="CLIP_ACTION_ARTICLE")Downsha.chromeExtension.clipArticleFromTab(a.tab,d);else if(b=="CLIP_ACTION_URL")Downsha.chromeExtension.clipUrlFromTab(a.tab,d);else{a.viewManager.showError("Invalid Clip selection");return}a.dismissPopup()})}else b.debug("Nothing to clip...")};Downsha.ChromePopup.prototype.selectQuickNoteAction=function(a){b.debug("ChromePopup.selectQuickNoteAction");
a&&this.getQuickNoteActionElement().find("input[value="+a+"]").attr("checked","checked")};Downsha.ChromePopup.prototype.getQuickNoteActionElement=function(){return $("form[name=quickNoteForm] #clipAction")};Downsha.ChromePopup.prototype.getQuickNoteAction=function(){return this.getQuickNoteActionElement().find("input:checked").first().attr("id")};Downsha.ChromePopup.prototype.cancelQuickNoteForm=function(){b.debug("Popup.cancelQuickNoteForm");this.resetQuickNote();this.dismissPopup()};Downsha.ChromePopup.prototype.resetQuickNote=
function(){b.debug("ChromePopup.resetQuickNote");this.updateBadge()};Downsha.ChromePopup.prototype.updateQuickNoteAction=function(){var a=this.getQuickNoteAction();a&&($("#quickNoteTips > span").hide(),$("#quickNoteTips > span[role="+a+"]").show());Downsha.Utils.isForbiddenUrl(this.tab.url)?b.debug("Not previewing quickNoteAction on forbiddenUrl"):(a&&"undefined"!=typeof Downsha.Constants.RequestType["PREVIEW_"+a]&&Downsha.Utils.notifyExtension(new Downsha.RequestMessage(Downsha.Constants.RequestType["PREVIEW_"+
a],{tabId:this.tab.id})),"CLIP_ACTION_ARTICLE"==a?this.enablePreviewAdjustment():this.disablePreviewAdjustment())};Downsha.ChromePopup.prototype.enablePreviewAdjustment=function(){b.debug("Popup.enablePreviewAdjustment");!this._previewAdjustmentEnabled&&"CLIP_ACTION_ARTICLE"==this.getQuickNoteAction()&&($("body").bind("keyup",{popup:this},this._handlePreviewAdjustment),this._previewAdjustmentEnabled=!0)};Downsha.ChromePopup.prototype.disablePreviewAdjustment=function(){b.debug("Popup.disablePreviewAdjustment");
this._previewAdjustmentEnabled&&($("body").unbind("keyup",this._handlePreviewAdjustment),this._previewAdjustmentEnabled=!1)};Downsha.ChromePopup.prototype._handlePreviewAdjustment=function(a){var b=a.data&&a.data.popup?a.data.popup:null,c=null;switch(a?a.keyCode:null){case 37:c=Downsha.Constants.RequestType.PREVIEW_NUDGE_PREVIOUS_SIBLING;break;case 38:c=Downsha.Constants.RequestType.PREVIEW_NUDGE_PARENT;break;case 39:c=Downsha.Constants.RequestType.PREVIEW_NUDGE_NEXT_SIBLING;break;case 40:c=Downsha.Constants.RequestType.PREVIEW_NUDGE_CHILD;
break;case 13:a.data&&a.data.popup&&b.submitQuickNoteForm();return}c&&Downsha.Utils.notifyExtension(new Downsha.RequestMessage(Downsha.Constants.RequestType.PREVIEW_NUDGE,{tabId:b.tab.id,direction:c}))};Downsha.ChromePopup.prototype.dismissPopup=function(a){var b=this;"undefined"!=typeof a&&a?(this.abort(),window.close()):setTimeout(function(){b.abort();window.close()},Downsha.ChromePopup.POPUP_DISMISS_TIMEOUT)};Downsha.ChromePopup.prototype.unabort=function(){b.debug("ChromePopup.unabort");this.aborted=
!1;this.viewManager.quiet=!1};Downsha.ChromePopup.prototype.abort=function(){b.debug("ChromePopup.abort");this.aborted=!0;this.viewManager.quiet=!0;this.abortProcs()};Downsha.ChromePopup.prototype.abortProcs=function(){b.debug("ChromePopup.abortProcs");this.loginProc&&"function"==typeof this.loginProc.abort&&(this.loginProc.abort(),this.loginProc=null)};Downsha.ChromePopup.prototype.goHome=function(){chrome.tabs.create({url:Downsha.context.getHomeUrl()});this.dismissPopup()};Downsha.ChromePopup.prototype.goDesktop=
function(){chrome.tabs.create({url:Downsha.context.getDesktopUrl()});this.dismissPopup()};Downsha.ChromePopup.prototype.goMobile=function(){chrome.tabs.create({url:Downsha.context.getMobileUrl()});this.dismissPopup()};Downsha.ChromePopup.prototype.goWindows8=function(){chrome.tabs.create({url:Downsha.context.getWindows8Url()});this.dismissPopup()};Downsha.ChromePopup.prototype.goChrome=function(){chrome.tabs.create({url:Downsha.context.getChromeUrl()});this.dismissPopup()};Downsha.ChromePopup.prototype.goFirefox=
function(){chrome.tabs.create({url:Downsha.context.getFirefoxUrl()});this.dismissPopup()};Downsha.ChromePopup.prototype.goRegister=function(){this.viewManager.switchView("registerView",{})};Downsha.ChromePopup.prototype.goLogin=function(){this.viewManager.switchView("loginView",{})};Downsha.ChromePopup.prototype.updateBadge=function(){Downsha.Utils.updateBadge(Downsha.context)};Downsha.ChromePopup.prototype.isArticleSane=function(){if(this.pageInfo&&this.pageInfo.articleBoundingClientRect){var a=
Math.round(this.pageInfo.documentWidth*this.pageInfo.documentHeight),d=Math.round(this.pageInfo.articleBoundingClientRect.width*this.pageInfo.articleBoundingClientRect.height),c=Math.round(0<a?100*d/a:0);b.debug("isArticleSane() PageArea: "+a+" ArticleArea: "+d+" Ratio: "+c+"%");return Downsha.Utils.isArticleSane(this.pageInfo.documentWidth,this.pageInfo.documentHeight,this.pageInfo.articleBoundingClientRect)}return!1}})();
